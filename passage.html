<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>文章导航 —— npp-zep</title>
  <!-- 引入样式文件 -->
  <link rel="stylesheet" href="style/style.css">
  <link rel="stylesheet" href="style/passage.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/206399566?v=4">

  <!-- 浏览器兼容性提示样式 -->
  <style>
    .browser-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ffcc00;
      color: #000;
      padding: 10px;
      text-align: center;
      z-index: 9999;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .browser-warning a {
      color: #0066cc;
      text-decoration: underline;
      margin-left: 5px;
    }

    /* 护眼模式样式 */
    :root[data-eye-protection="true"] {
      --eye-protection-bg: #C7EDCC !important;
      --eye-protection-text: #333333 !important;
      --eye-protection-code-bg: #f0f0f0 !important;
    }

    :root[data-eye-protection="true"][data-theme="dark"] {
      --eye-protection-bg: #0A2F1C !important;
      --eye-protection-text: #E8F5E9 !important;
      --eye-protection-code-bg: #1A3B2A !important;
    }

    .eye-protection-active {
      background-color: var(--eye-protection-bg, #C7EDCC) !important;
      color: var(--eye-protection-text, #333333) !important;
    }

    .eye-protection-active .markdown-content {
      background-color: var(--eye-protection-bg, #C7EDCC) !important;
      color: var(--eye-protection-text, #333333) !important;
    }

    .eye-protection-active code,
    .eye-protection-active pre {
      background-color: var(--eye-protection-code-bg, #f0f0f0) !important;
    }

    /* 搜索框样式 */
    .search-container {
      margin: 1.5rem 0;
      position: relative;
    }

    .search-box {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.5rem;
      border: 1px solid var(--border-color, #ddd);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--card-bg, #fff);
      color: var(--text-color, #333);
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary-color, #4a90e2);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary, #666);
    }

    .search-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .search-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border-color, #ddd);
      background-color: var(--card-bg, #fff);
      color: var(--text-color, #333);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .search-btn:hover {
      background-color: var(--hover-bg, #f5f5f5);
    }

    .search-btn.active {
      background-color: var(--primary-color, #4a90e2);
      color: white;
      border-color: var(--primary-color, #4a90e2);
    }

    .search-results-info {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary, #666);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0.1rem 0.2rem;
      border-radius: 2px;
      transition: background-color 0.3s ease;
    }

    .search-highlight.active {
      background-color: rgba(255, 200, 0, 0.6);
      animation: pulse 1s ease-in-out;
    }

    @keyframes pulse {
      0% { background-color: rgba(255, 255, 0, 0.3); }
      50% { background-color: rgba(255, 200, 0, 0.8); }
      100% { background-color: rgba(255, 200, 0, 0.6); }
    }

    .article-card.search-match {
      border-left: 4px solid var(--primary-color, #4a90e2);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary, #666);
    }

    .no-results i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* 护眼模式切换按钮 */
    .eye-protection-toggle {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--card-bg, #fff);
      border: 2px solid var(--border-color, #ddd);
      color: var(--text-color, #333);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .eye-protection-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .eye-protection-toggle.active {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }

    /* 搜索结果导航 */
    .search-navigation {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .nav-btn {
      padding: 0.3rem 0.6rem;
      border: 1px solid var(--border-color, #ddd);
      background-color: var(--card-bg, #fff);
      color: var(--text-color, #333);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .nav-btn:hover:not(:disabled) {
      background-color: var(--hover-bg, #f5f5f5);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .current-match {
      font-weight: bold;
      color: var(--primary-color, #4a90e2);
    }
  </style>
</head>

<body>
  <!-- 浏览器兼容性提示 -->
  <div class="browser-warning" id="browserWarning">
    检测到您的浏览器版本较低，建议使用 <a href="https://www.google.com/chrome/" target="_blank">Chrome</a>、<a
      href="https://www.mozilla.org/firefox/" target="_blank">Firefox</a> 或 <a href="https://www.microsoft.com/edge"
      target="_blank">Edge</a> 以获得最佳体验
    <button onclick="document.getElementById('browserWarning').style.display='none'"
      style="margin-left: 15px; background: #fff; border: 1px solid #ccc; padding: 2px 8px; cursor: pointer;">×</button>
  </div>

  <!-- 护眼模式切换按钮 -->
  <button class="eye-protection-toggle" id="eyeProtectionToggle" title="切换护眼模式">
    <i class="fas fa-eye"></i>
  </button>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <div class="bg-container" id="bgContainer">
    <div class="bg-overlay"></div>
    <img src="assets/pic/bg.png" alt="背景" class="bg-image" id="bgImage">
    <button class="bg-toggle" id="bgToggle" title="切换背景显示">
      <i class="fas fa-eye"></i>
    </button>
  </div>

  <div class="container">
    <header>
      <h1>文章导航
        <small>知识分享 · 学习笔记</small>
      </h1>
      <p class="tagline">记录思考，分享见解</p>
    </header>

    <main class="main-content">
      <section class="description">
        <div class="profile-header">
          <img src="https://avatars.githubusercontent.com/u/206399566?v=4" alt="头像" class="avatar">
          <h2>我的文章</h2>
        </div>

        <div class="info-section">
          <h3><i class="fas fa-info-circle"></i> 说明</h3>
          <p>这里是我在学习过程中的见解和想法，会非常的杂乱</p>

          <!-- 搜索框 -->
          <div class="search-container">
            <div style="position: relative;">
              <i class="fas fa-search search-icon"></i>
              <input type="text" 
                     id="searchInput" 
                     class="search-box" 
                     placeholder="搜索文章标题、描述或标签... 支持正则表达式"
                     autocomplete="off">
            </div>
            
            <div class="search-actions">
              <button class="search-btn" id="searchTitleBtn" data-search-type="title">标题</button>
              <button class="search-btn" id="searchContentBtn" data-search-type="content">内容</button>
              <button class="search-btn" id="searchTagsBtn" data-search-type="tags">标签</button>
              <button class="search-btn" id="searchAllBtn" data-search-type="all" class="active">全部</button>
              <button class="search-btn" id="clearSearchBtn">
                <i class="fas fa-times"></i> 清除
              </button>
            </div>

            <div class="search-results-info" id="searchResultsInfo" style="display: none;">
              <span id="resultsCount">找到 0 个结果</span>
              <div class="search-navigation" id="searchNavigation" style="display: none;">
                <button class="nav-btn" id="prevMatchBtn" disabled>上一个</button>
                <span id="currentMatch">0 / 0</span>
                <button class="nav-btn" id="nextMatchBtn" disabled>下一个</button>
              </div>
            </div>
          </div>

          <h3><i class="fas fa-filter"></i> 筛选文章</h3>
          <div class="filter-section">
            <div class="filter-buttons">
              <button class="filter-btn active" data-filter="all">全部文章</button>
              <button class="filter-btn" data-filter="web">Web开发</button>
              <button class="filter-btn" data-filter="lua">Lua开发</button>
              <button class="filter-btn" data-filter="python">Python</button>
              <button class="filter-btn" data-filter="tutorial">教程</button>
              <button class="filter-btn" data-filter="note">笔记</button>
              <button class="filter-btn" data-filter="project">项目</button>
              <button class="filter-btn" data-filter="document">文档</button>
              <button class="filter-btn" data-filter="api">API文档</button>
              <button class="filter-btn" data-filter="guide">指南</button>
            </div>
          </div>
        </div>

        <div class="articles-section">
          <h3><i class="fas fa-book-open"></i> 文章列表</h3>
          <div class="articles-list" id="articlesList">
            <div class="loading-articles">
              <div class="loading-spinner"></div>
              <p>正在加载文章列表...</p>
            </div>
          </div>
        </div>
      </section>

      <aside class="cta-section">
        <a href="index.html" class="btn">
          <i class="fas fa-home"></i> 返回首页
        </a>

        <a href="https://github.com/npp-zep" target="_blank" class="btn">
          <i class="fab fa-github"></i> GitHub 主页
        </a>

        <div class="quick-links">
          <h4>快速链接</h4>
          <a href="#articles" class="quick-link">查看文章</a>
          <a href="#about" class="quick-link">关于本站</a>
          <a href="https://github.com/npp-zep/npp-zep.github.io" target="_blank" class="quick-link">源代码</a>
        </div>

        <div class="stats-section" id="statsSection">
        </div>
      </aside>
    </main>

    <footer>
      <p>遵循 <a href="https://opensource.org/licenses/MIT" target="_blank" class="license-link">MIT 协议</a></p>
      <p class="footer-note">文章内容采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC
          BY-NC-SA 4.0</a> 许可协议</p>
    </footer>
  </div>

  <div class="markdown-viewer" id="markdownViewer">
    <div class="markdown-header">
      <button class="back-btn" id="backBtn">
        <i class="fas fa-arrow-left"></i> <span class="back-text">返回</span>
      </button>
      <h2 class="markdown-title" id="markdownTitle"></h2>
      <div class="markdown-actions">
        <button class="action-btn" id="toggleSidebarBtn">
          <i class="fas fa-bars"></i> <span>目录</span>
        </button>
        <button class="action-btn" id="themeToggleBtn">
          <i class="fas fa-palette"></i> <span>主题</span>
        </button>
        <button class="action-btn" id="copyBtn">
          <i class="far fa-copy"></i>
          <span>复制</span>
        </button>
      </div>
    </div>

    <div class="markdown-container">
      <div class="markdown-sidebar" id="markdownSidebar">
        <h3 class="toc-title"><i class="fas fa-list"></i> 目录</h3>
        <ul class="toc-list" id="tocList">
        </ul>

        <div class="theme-options">
          <h4><i class="fas fa-palette"></i> 代码主题</h4>
          <select class="theme-select" id="codeThemeSelect">
            <option value="github-dark">GitHub Dark</option>
            <option value="github">GitHub Light</option>
            <option value="vs2015">VS 2015</option>
            <option value="atom-one-dark">Atom One Dark</option>
            <option value="monokai">Monokai</option>
            <option value="solarized-dark">Solarized Dark</option>
          </select>
        </div>

        <div class="article-info-panel" id="articleInfoPanel">
          <h4><i class="fas fa-info-circle"></i> 文章信息</h4>
          <div class="article-info-content">
            <div class="info-item">
              <span class="info-label">文章字数：</span>
              <span class="info-value" id="articleWordCount">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">加载时间：</span>
              <span class="info-value" id="articleLoadTime">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">阅读时长：</span>
              <span class="info-value" id="articleReadTime">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">文件大小：</span>
              <span class="info-value" id="articleFileSize">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 侧边栏遮罩层 -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <div class="markdown-content" id="markdownContent">
      </div>
    </div>
  </div>

  <button class="theme-switcher" id="themeSwitcher">
    <i class="fas fa-moon" id="themeIcon"></i>
  </button>

  <!-- 兼容性处理：旧版浏览器支持 -->
  <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.16/es5-shim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.35.6/es6-shim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
    <![endif]-->

  <!-- 引入highlight.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/lua.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/markdown.min.js"></script>

  <!-- 引入marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- 引入修复后的rendermd.js -->
  <script src="script/rendermd.js"></script>

  <!-- 主脚本 -->
  <script>
    // 浏览器兼容性检测
    function checkBrowserCompatibility() {
      var warning = document.getElementById('browserWarning');
      var isOldIE = /*@cc_on!@*/false || !!document.documentMode; // IE 6-11
      var isEdge = /Edge\/\d+/.test(navigator.userAgent);
      var isOldChrome = /Chrome\/([0-9]+)/.test(navigator.userAgent) && parseInt(RegExp.$1) < 50;
      var isOldFirefox = /Firefox\/([0-9]+)/.test(navigator.userAgent) && parseInt(RegExp.$1) < 50;
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // 检测关键API支持
      var missingAPIs = [];
      if (typeof fetch === 'undefined') missingAPIs.push('fetch API');
      if (typeof Promise === 'undefined') missingAPIs.push('Promise');
      if (typeof Set === 'undefined') missingAPIs.push('Set');

      if (isOldIE || isOldChrome || isOldFirefox || missingAPIs.length > 0) {
        warning.style.display = 'block';
        console.warn('浏览器兼容性问题检测到:', {
          isOldIE: isOldIE,
          isOldChrome: isOldChrome,
          isOldFirefox: isOldFirefox,
          missingAPIs: missingAPIs,
          userAgent: navigator.userAgent
        });
      }

      // 移动端特定优化
      if (isMobile) {
        // 移动端减少动画
        document.documentElement.style.setProperty('--transition', '0.2s ease');
        // 移动端禁用部分效果
        localStorage.setItem('bgVisible', 'false');
        document.getElementById('bgContainer').style.opacity = '0';
      }

      return {
        isModern: !isOldIE && !isOldChrome && !isOldFirefox && missingAPIs.length === 0,
        isMobile: isMobile,
        isIE: isOldIE
      };
    }

    const ARTICLES_CONFIG_URL = 'assets/passage/articles.json';
    const ARTICLES_BASE_URL = 'assets/passage/';
    let allArticles = [];
    let currentArticleStats = null;
    
    // 搜索相关变量
    let currentSearchType = 'all';
    let searchResults = [];
    let currentMatchIndex = -1;
    let searchHighlights = [];

    // 页面初始化
    window.addEventListener('load', function () {
      // 检查浏览器兼容性
      var compatibility = checkBrowserCompatibility();

      // 设置加载超时
      var loadingTimeout = setTimeout(function () {
        document.getElementById('loading').style.opacity = '0';
        setTimeout(function () {
          document.getElementById('loading').style.display = 'none';
        }, 500);
      }, 1000);

      // 加载文章数据
      loadArticles();
      initThemeSwitcher();
      initBackgroundToggle();
      initMarkdownViewer();
      initEyeProtection();
      initSearch();

      // 如果加载完成，清除超时
      clearTimeout(loadingTimeout);
      setTimeout(function () {
        document.getElementById('loading').style.opacity = '0';
        setTimeout(function () {
          document.getElementById('loading').style.display = 'none';
        }, 500);
      }, 500);
    });

    // 初始化护眼模式
    function initEyeProtection() {
      const eyeToggle = document.getElementById('eyeProtectionToggle');
      const html = document.documentElement;
      
      // 从本地存储获取护眼模式状态
      const eyeProtectionEnabled = localStorage.getItem('eyeProtection') === 'true';
      
      // 设置初始状态
      if (eyeProtectionEnabled) {
        html.setAttribute('data-eye-protection', 'true');
        eyeToggle.classList.add('active');
        eyeToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
        eyeToggle.title = '关闭护眼模式';
      } else {
        html.setAttribute('data-eye-protection', 'false');
        eyeToggle.classList.remove('active');
        eyeToggle.innerHTML = '<i class="fas fa-eye"></i>';
        eyeToggle.title = '开启护眼模式';
      }
      
      // 添加点击事件
      eyeToggle.addEventListener('click', function() {
        const currentState = html.getAttribute('data-eye-protection');
        const newState = currentState === 'true' ? 'false' : 'true';
        
        html.setAttribute('data-eye-protection', newState);
        localStorage.setItem('eyeProtection', newState);
        
        if (newState === 'true') {
          eyeToggle.classList.add('active');
          eyeToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
          eyeToggle.title = '关闭护眼模式';
          
          // 如果正在阅读文章，应用护眼模式到文章内容
          const markdownViewer = document.getElementById('markdownViewer');
          if (markdownViewer.style.display === 'flex') {
            document.body.classList.add('eye-protection-active');
          }
        } else {
          eyeToggle.classList.remove('active');
          eyeToggle.innerHTML = '<i class="fas fa-eye"></i>';
          eyeToggle.title = '开启护眼模式';
          
          // 移除护眼模式样式
          document.body.classList.remove('eye-protection-active');
        }
        
        // 添加点击动画
        eyeToggle.style.transform = 'scale(0.9)';
        setTimeout(() => {
          eyeToggle.style.transform = '';
        }, 200);
      });
    }

    // 初始化搜索功能
    function initSearch() {
      const searchInput = document.getElementById('searchInput');
      const searchTitleBtn = document.getElementById('searchTitleBtn');
      const searchContentBtn = document.getElementById('searchContentBtn');
      const searchTagsBtn = document.getElementById('searchTagsBtn');
      const searchAllBtn = document.getElementById('searchAllBtn');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      const prevMatchBtn = document.getElementById('prevMatchBtn');
      const nextMatchBtn = document.getElementById('nextMatchBtn');
      const resultsInfo = document.getElementById('searchResultsInfo');
      const searchNavigation = document.getElementById('searchNavigation');

      // 设置初始搜索类型
      setSearchType('all');

      // 搜索类型按钮点击事件
      searchTitleBtn.addEventListener('click', () => setSearchType('title'));
      searchContentBtn.addEventListener('click', () => setSearchType('content'));
      searchTagsBtn.addEventListener('click', () => setSearchType('tags'));
      searchAllBtn.addEventListener('click', () => setSearchType('all'));

      // 清除搜索
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearch();
        updateSearchUI();
      });

      // 搜索输入事件（防抖）
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(e.target.value);
        }, 300);
      });

      // 搜索快捷键
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          performSearch(e.target.value);
        }
        if (e.key === 'Escape') {
          searchInput.value = '';
          clearSearch();
          updateSearchUI();
        }
      });

      // 搜索结果导航
      prevMatchBtn.addEventListener('click', () => navigateSearch(-1));
      nextMatchBtn.addEventListener('click', () => navigateSearch(1));

      // 设置搜索类型
      function setSearchType(type) {
        currentSearchType = type;
        
        // 更新按钮状态
        [searchTitleBtn, searchContentBtn, searchTagsBtn, searchAllBtn].forEach(btn => {
          btn.classList.remove('active');
        });
        
        document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}Btn`).classList.add('active');
        
        // 如果搜索框有内容，重新搜索
        if (searchInput.value.trim()) {
          performSearch(searchInput.value);
        }
      }

      // 执行搜索
      function performSearch(query) {
        if (!query.trim()) {
          clearSearch();
          updateSearchUI();
          return;
        }

        try {
          // 尝试将查询作为正则表达式处理
          let regex;
          try {
            regex = new RegExp(query, 'i');
          } catch (e) {
            // 如果正则表达式无效，使用普通字符串搜索
            regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
          }

          searchResults = [];
          searchHighlights = [];

          // 搜索文章
          allArticles.forEach((article, index) => {
            let matches = [];
            let score = 0;

            // 根据搜索类型匹配
            switch (currentSearchType) {
              case 'title':
                if (article.title && regex.test(article.title)) {
                  matches.push({ type: 'title', text: article.title });
                  score += 10;
                }
                break;
                
              case 'content':
                if (article.description && regex.test(article.description)) {
                  matches.push({ type: 'description', text: article.description });
                  score += 5;
                }
                break;
                
              case 'tags':
                if (article.tags && article.tags.some(tag => regex.test(tag))) {
                  matches.push({ type: 'tags', text: article.tags.join(', ') });
                  score += 8;
                }
                break;
                
              case 'all':
                if (article.title && regex.test(article.title)) {
                  matches.push({ type: 'title', text: article.title });
                  score += 10;
                }
                if (article.description && regex.test(article.description)) {
                  matches.push({ type: 'description', text: article.description });
                  score += 5;
                }
                if (article.tags && article.tags.some(tag => regex.test(tag))) {
                  matches.push({ type: 'tags', text: article.tags.join(', ') });
                  score += 8;
                }
                break;
            }

            if (matches.length > 0) {
              searchResults.push({
                article: article,
                index: index,
                matches: matches,
                score: score
              });
            }
          });

          // 按分数排序
          searchResults.sort((a, b) => b.score - a.score);

          // 更新UI
          updateSearchResults();
          updateSearchUI();
          
          // 如果有结果，导航到第一个
          if (searchResults.length > 0) {
            navigateToMatch(0);
          }
          
        } catch (error) {
          console.error('搜索错误:', error);
          showSearchError('搜索错误: ' + error.message);
        }
      }

      // 更新搜索结果显示
      function updateSearchResults() {
        const articlesList = document.getElementById('articlesList');
        const articleCards = articlesList.querySelectorAll('.article-card');
        
        // 重置所有卡片
        articleCards.forEach(card => {
          card.classList.remove('search-match');
          card.style.display = 'none';
        });
        
        // 显示匹配的卡片
        searchResults.forEach(result => {
          const card = articleCards[result.index];
          if (card) {
            card.classList.add('search-match');
            card.style.display = 'block';
            
            // 高亮匹配文本
            highlightCardText(card, result);
          }
        });
        
        // 如果没有匹配结果，显示提示
        if (searchResults.length === 0 && searchInput.value.trim()) {
          articlesList.innerHTML += `
            <div class="no-results">
              <i class="fas fa-search"></i>
              <h3>未找到匹配的文章</h3>
              <p>尝试使用不同的关键词或搜索类型</p>
            </div>
          `;
        }
      }

      // 高亮卡片文本
      function highlightCardText(card, result) {
        try {
          let query = searchInput.value.trim();
          let regex;
          
          try {
            regex = new RegExp(query, 'gi');
          } catch (e) {
            regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
          }
          
          // 高亮标题
          const titleElement = card.querySelector('.article-title');
          if (titleElement) {
            const originalTitle = titleElement.textContent;
            const highlightedTitle = originalTitle.replace(regex, match => 
              `<span class="search-highlight">${match}</span>`
            );
            titleElement.innerHTML = highlightedTitle;
          }
          
          // 高亮描述
          const descElement = card.querySelector('.article-description');
          if (descElement) {
            const originalDesc = descElement.textContent;
            const highlightedDesc = originalDesc.replace(regex, match => 
              `<span class="search-highlight">${match}</span>`
            );
            descElement.innerHTML = highlightedDesc;
          }
          
          // 高亮标签
          const tagElements = card.querySelectorAll('.article-tag');
          tagElements.forEach(tag => {
            const originalTag = tag.textContent;
            if (regex.test(originalTag)) {
              tag.innerHTML = originalTag.replace(regex, match => 
                `<span class="search-highlight">${match}</span>`
              );
            }
          });
          
        } catch (error) {
          console.error('高亮错误:', error);
        }
      }

      // 清除搜索
      function clearSearch() {
        searchResults = [];
        currentMatchIndex = -1;
        searchHighlights = [];
        
        // 重置所有卡片
        const articlesList = document.getElementById('articlesList');
        const articleCards = articlesList.querySelectorAll('.article-card');
        
        articleCards.forEach(card => {
          card.classList.remove('search-match');
          card.style.display = 'block';
          
          // 移除高亮
          const highlights = card.querySelectorAll('.search-highlight');
          highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            while (highlight.firstChild) {
              parent.insertBefore(highlight.firstChild, highlight);
            }
            parent.removeChild(highlight);
          });
        });
        
        // 移除无结果提示
        const noResults = articlesList.querySelector('.no-results');
        if (noResults) {
          noResults.remove();
        }
      }

      // 更新搜索UI
      function updateSearchUI() {
        const resultsInfo = document.getElementById('searchResultsInfo');
        const searchNavigation = document.getElementById('searchNavigation');
        const resultsCount = document.getElementById('resultsCount');
        const currentMatch = document.getElementById('currentMatch');
        
        if (searchInput.value.trim() && searchResults.length > 0) {
          resultsInfo.style.display = 'flex';
          searchNavigation.style.display = 'flex';
          resultsCount.textContent = `找到 ${searchResults.length} 个结果`;
          currentMatch.textContent = `${currentMatchIndex + 1} / ${searchResults.length}`;
          
          // 更新导航按钮状态
          document.getElementById('prevMatchBtn').disabled = currentMatchIndex <= 0;
          document.getElementById('nextMatchBtn').disabled = currentMatchIndex >= searchResults.length - 1;
        } else if (searchInput.value.trim()) {
          resultsInfo.style.display = 'flex';
          searchNavigation.style.display = 'none';
          resultsCount.textContent = `找到 0 个结果`;
        } else {
          resultsInfo.style.display = 'none';
          searchNavigation.style.display = 'none';
        }
      }

      // 导航到匹配项
      function navigateToMatch(index) {
        if (index < 0 || index >= searchResults.length) return;
        
        // 移除之前的高亮
        searchHighlights.forEach(highlight => {
          highlight.classList.remove('active');
        });
        
        currentMatchIndex = index;
        const result = searchResults[index];
        
        // 滚动到匹配的文章卡片
        const articlesList = document.getElementById('articlesList');
        const card = articlesList.querySelectorAll('.article-card')[result.index];
        
        if (card) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // 添加高亮动画
          const highlights = card.querySelectorAll('.search-highlight');
          highlights.forEach(highlight => {
            highlight.classList.add('active');
            searchHighlights.push(highlight);
          });
        }
        
        updateSearchUI();
      }

      // 导航搜索
      function navigateSearch(direction) {
        const newIndex = currentMatchIndex + direction;
        if (newIndex >= 0 && newIndex < searchResults.length) {
          navigateToMatch(newIndex);
        }
      }

      // 显示搜索错误
      function showSearchError(message) {
        const articlesList = document.getElementById('articlesList');
        articlesList.innerHTML += `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>搜索错误</h3>
            <p>${message}</p>
            <p style="font-size: 0.85rem; margin-top: 1rem;">请检查您的搜索表达式是否正确。</p>
          </div>
        `;
      }
    }

    // 智能超时计算函数
    function calculateTimeout(fileSize) {
      // 基础超时时间
      let baseTimeout = 15000; // 15秒

      // 根据文件大小动态调整超时时间
      if (fileSize > 1024 * 1024) { // 大于1MB
        return 60000; // 60秒
      } else if (fileSize > 500 * 1024) { // 大于500KB
        return 45000; // 45秒
      } else if (fileSize > 100 * 1024) { // 大于100KB
        return 30000; // 30秒
      } else {
        return baseTimeout;
      }
    }

    // 兼容性fetch函数
    function safeFetch(url, options) {
      options = options || {};

      // 如果原生fetch不可用，使用XMLHttpRequest
      if (typeof fetch === 'undefined') {
        return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.open(options.method || 'GET', url, true);

          // 设置请求头
          if (options.headers) {
            for (var header in options.headers) {
              if (options.headers.hasOwnProperty(header)) {
                xhr.setRequestHeader(header, options.headers[header]);
              }
            }
          }

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status >= 200 && xhr.status < 300) {
                resolve({
                  ok: true,
                  status: xhr.status,
                  text: function () {
                    return Promise.resolve(xhr.responseText);
                  },
                  json: function () {
                    try {
                      return Promise.resolve(JSON.parse(xhr.responseText));
                    } catch (e) {
                      return Promise.reject(e);
                    }
                  }
                });
              } else {
                reject(new Error('HTTP错误! 状态: ' + xhr.status));
              }
            }
          };

          xhr.onerror = function () {
            reject(new Error('网络错误'));
          };

          xhr.ontimeout = function () {
            reject(new Error('请求超时'));
          };

          if (options.timeout) {
            xhr.timeout = options.timeout;
          }

          xhr.send(options.body);
        });
      }

      // 使用原生fetch
      return fetch(url, options);
    }

    async function loadArticles() {
      const articlesList = document.getElementById('articlesList');

      try {
        articlesList.innerHTML = `
                    <div class="loading-articles">
                        <div class="loading-spinner"></div>
                        <p>正在加载文章列表...</p>
                    </div>
                `;

        console.log('正在加载文章配置文件:', ARTICLES_CONFIG_URL);

        // 自动调整超时时间
        const timeout = calculateTimeout(0);

        // 使用安全的fetch
        const response = await safeFetch(ARTICLES_CONFIG_URL, {
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          },
          cache: 'no-cache',
          timeout: timeout
        });

        if (!response.ok) {
          throw new Error(`HTTP错误! 状态: ${response.status} - ${response.statusText}`);
        }

        const jsonText = await response.text();
        console.log('原始JSON数据:', jsonText.substring(0, 500) + '...');

        // 处理可能的BOM头
        const cleanJsonText = jsonText.trim().replace(/^\uFEFF/, '');
        let articlesData;

        // 安全的JSON解析
        try {
          articlesData = JSON.parse(cleanJsonText);
        } catch (e) {
          // 尝试修复常见的JSON格式问题
          const fixedJson = cleanJsonText
            .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":') // 修复键名引号
            .replace(/,\s*}/g, '}') // 修复尾部逗号
            .replace(/,\s*]/g, ']'); // 修复数组尾部逗号

          articlesData = JSON.parse(fixedJson);
        }

        allArticles = articlesData.articles || [];

        if (!Array.isArray(allArticles) || allArticles.length === 0) {
          throw new Error('文章数据格式错误或为空');
        }

        // 清理和验证文章数据
        allArticles = cleanArticlesData(allArticles);

        articlesList.innerHTML = '';

        // 分批渲染文章卡片，避免阻塞UI
        function renderArticlesBatch(startIndex, batchSize) {
          const endIndex = Math.min(startIndex + batchSize, allArticles.length);

          for (let i = startIndex; i < endIndex; i++) {
            const article = allArticles[i];
            const articleElement = createArticleCard(article);
            articlesList.appendChild(articleElement);
          }

          // 如果还有更多文章，继续分批渲染
          if (endIndex < allArticles.length) {
            setTimeout(function () {
              renderArticlesBatch(endIndex, batchSize);
            }, 50);
          } else {
            // 所有文章渲染完成
            updateStats();
            initFilter();
            console.log('成功加载', allArticles.length, '篇文章');
          }
        }

        // 开始分批渲染
        renderArticlesBatch(0, 5); // 每批渲染5篇文章

      } catch (error) {
        console.error('加载文章失败:', error);
        showError('无法加载文章列表', error.message);
      }
    }

    // 清理和验证文章数据
    function cleanArticlesData(articles) {
      return articles.map(article => {
        const cleaned = {};

        // 确保所有字段都是字符串
        cleaned.title = String(article.title || '无标题');
        cleaned.date = String(article.date || '未知日期');
        cleaned.readTime = String(article.readTime || '未知');
        cleaned.description = String(article.description || '暂无描述');
        cleaned.file = String(article.file || '');

        // 添加字数统计
        if (article.wordCount !== undefined) {
          cleaned.wordCount = parseInt(article.wordCount) || 0;
        } else if (article.words !== undefined) {
          cleaned.wordCount = parseInt(article.words) || 0;
        } else {
          cleaned.wordCount = Math.max(
            cleaned.description.length * 3,
            800
          );
        }

        // 处理tags
        if (Array.isArray(article.tags)) {
          cleaned.tags = article.tags.map(tag => String(tag));
        } else if (typeof article.tags === 'string') {
          cleaned.tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
        } else {
          cleaned.tags = [];
        }

        // 安全检查和清理
        if (cleaned.description === '[object Object]') {
          cleaned.description = '暂无描述';
        }

        if (cleaned.description && cleaned.description.includes('[project]')) {
          cleaned.description = cleaned.description.replace(/\[project\]\s*:\s*project/g, '项目说明');
        }

        return cleaned;
      });
    }

    function showError(title, message) {
      const articlesList = document.getElementById('articlesList');

      articlesList.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <p style="font-size: 0.85rem; margin-top: 1rem;">请检查文件路径是否正确，并确保 <code>articles.json</code> 文件存在。</p>
                    <button onclick="loadArticles()" class="article-btn" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> 重试加载
                    </button>
                </div>
            `;

      document.getElementById('statsSection').innerHTML = '';
    }

    function createArticleCard(article) {
      const articleCard = document.createElement('div');
      articleCard.className = 'article-card';

      // 确保tags是字符串数组
      const tagsArray = Array.isArray(article.tags) ? article.tags :
        (typeof article.tags === 'string' ?
          article.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []);

      articleCard.dataset.tags = tagsArray.join(' ');

      const tagsHtml = tagsArray.map(tag =>
        `<span class="article-tag tag-${tag.toLowerCase()}">${tag}</span>`
      ).join('');

      const safeFile = article.file || '';
      const safeTitle = article.title || '无标题';
      const safeDescription = article.description || '暂无描述';

      const finalDescription = typeof safeDescription === 'object' ? '暂无描述' : safeDescription;

      // 格式化字数显示
      const wordCount = article.wordCount || 0;
      const wordCountFormatted = formatWordCount(wordCount);

      articleCard.innerHTML = `
                <div class="article-header">
                    <h4 class="article-title">${article.title || '无标题'}</h4>
                    <div class="article-meta">
                        <span class="article-date"><i class="far fa-calendar"></i> ${article.date || '未知日期'}</span>
                        <span class="article-read-time"><i class="far fa-clock"></i> ${article.readTime || '未知'}</span>
                        <span class="article-word-count"><i class="fas fa-file-word"></i> ${wordCountFormatted}</span>
                    </div>
                </div>
                <p class="article-description">${finalDescription}</p>
                <div class="article-footer">
                    <div class="article-tags">
                        ${tagsHtml}
                    </div>
                    <div class="article-actions">
                        <button class="article-btn read-btn">
                            <i class="fas fa-book-open"></i> 阅读
                        </button>
                        <button class="article-btn download-btn">
                            <i class="fas fa-download"></i> 下载
                        </button>
                    </div>
                </div>
            `;

      // 使用事件委托添加点击事件
      const readBtn = articleCard.querySelector('.read-btn');
      const downloadBtn = articleCard.querySelector('.download-btn');

      readBtn.addEventListener('click', () => {
        openArticle(safeFile, safeTitle, article);
      });

      downloadBtn.addEventListener('click', () => {
        downloadArticle(safeFile);
      });

      return articleCard;
    }

    function initFilter() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const articlesList = document.getElementById('articlesList');

      filterButtons.forEach(button => {
        // 使用兼容性事件绑定
        if (button.addEventListener) {
          button.addEventListener('click', filterHandler);
        } else if (button.attachEvent) { // 兼容IE8及以下
          button.attachEvent('onclick', filterHandler);
        }
      });

      function filterHandler() {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        const filter = this.dataset.filter || this.getAttribute('data-filter');
        const articleCards = document.querySelectorAll('.article-card');

        articleCards.forEach(card => {
          const cardTags = card.dataset.tags || card.getAttribute('data-tags');
          if (filter === 'all' || (cardTags && cardTags.includes(filter))) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });

        articlesList.style.opacity = '0.5';
        setTimeout(() => {
          articlesList.style.opacity = '1';
        }, 300);
      }
    }

    function updateStats() {
      const statsSection = document.getElementById('statsSection');

      if (!allArticles || allArticles.length === 0) {
        statsSection.innerHTML = '';
        return;
      }

      const totalArticles = allArticles.length;

      // 计算总字数
      let totalWords = 0;
      let validWordCountArticles = 0;

      allArticles.forEach(article => {
        if (article.wordCount && article.wordCount > 0) {
          totalWords += article.wordCount;
          validWordCountArticles++;
        }
      });

      if (totalWords === 0) {
        totalWords = allArticles.length * 800;
      }

      // 计算各类别文章数量
      const webArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('web') || tag.toLowerCase() === 'web'
      )).length;

      const luaArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('lua') || tag.toLowerCase() === 'lua'
      )).length;

      const pythonArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('python') || tag.toLowerCase() === 'python'
      )).length;

      const tutorialArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('tutorial') || tag.toLowerCase() === 'tutorial'
      )).length;

      const noteArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('note') || tag.toLowerCase() === 'note'
      )).length;

      const projectArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('project') || tag.toLowerCase() === 'project'
      )).length;

      const documentArticles = allArticles.filter(a => a.tags && a.tags.some(tag =>
        tag.toLowerCase().includes('document') || tag.toLowerCase() === 'document'
      )).length;

      // 创建统计
      const totalDays = Math.max(totalArticles * 3, 30);
      const months = Math.floor(totalDays / 30);

      const wordsDisplay = formatWordCount(totalWords);

      // 统计文档类型
      const docTypeStats = {};
      allArticles.forEach(article => {
        if (article.tags && Array.isArray(article.tags)) {
          article.tags.forEach(tag => {
            const lowerTag = tag.toLowerCase();
            const docTypes = ['project', 'document', 'api', 'guide', 'tutorial', 'note', 'web', 'python', 'lua'];
            const matchedType = docTypes.find(type => lowerTag.includes(type) || lowerTag === type);

            if (matchedType) {
              docTypeStats[matchedType] = (docTypeStats[matchedType] || 0) + 1;
            }
          });
        }
      });

      let docTypeBadgesHtml = '';
      if (Object.keys(docTypeStats).length > 0) {
        const docTypeNames = {
          'project': '项目',
          'document': '文档',
          'api': 'API',
          'guide': '指南',
          'tutorial': '教程',
          'note': '笔记',
          'web': 'Web',
          'python': 'Python',
          'lua': 'Lua'
        };

        const sortedTypes = Object.entries(docTypeStats)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 6);

        docTypeBadgesHtml = `
                    <div class="stats-doc-types">
                        <h4><i class="fas fa-tags"></i> 热门标签</h4>
                        <div class="doc-type-badges">
                            ${sortedTypes.map(([type, count]) => `
                                <span class="doc-type-badge">
                                    <span class="badge-count">${count}</span>
                                    ${docTypeNames[type] || type}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
      }

      const avgWordsPerArticle = Math.round(totalWords / Math.max(totalArticles, 1));
      const maxWordsArticle = allArticles.reduce((max, article) =>
        Math.max(max, article.wordCount || 0), 0);

      statsSection.innerHTML = `
                <div class="stats-card">
                    <h4><i class="fas fa-chart-bar"></i> 文章统计</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">${totalArticles}</span>
                            <span class="stat-label">总文章数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${wordsDisplay}</span>
                            <span class="stat-label">总字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(avgWordsPerArticle)}</span>
                            <span class="stat-label">平均字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${webArticles}</span>
                            <span class="stat-label">Web开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${luaArticles}</span>
                            <span class="stat-label">Lua开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${pythonArticles}</span>
                            <span class="stat-label">Python</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${tutorialArticles}</span>
                            <span class="stat-label">教程</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${noteArticles}</span>
                            <span class="stat-label">笔记</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${projectArticles}</span>
                            <span class="stat-label">项目</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${documentArticles}</span>
                            <span class="stat-label">文档</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${months}</span>
                            <span class="stat-label">持续${months}个月</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(maxWordsArticle)}</span>
                            <span class="stat-label">最长文章</span>
                        </div>
                    </div>
                    <div class="word-count-details">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.8rem;">
                            <i class="fas fa-info-circle"></i> 
                            统计了 ${validWordCountArticles}/${totalArticles} 篇文章的实际字数
                        </p>
                    </div>
                    ${docTypeBadgesHtml}
                </div>
            `;
    }

    function formatWordCount(wordCount) {
      if (wordCount >= 10000) {
        return `${(wordCount / 10000).toFixed(1)}万`;
      } else if (wordCount >= 1000) {
        return `${(wordCount / 1000).toFixed(1)}千`;
      } else {
        return formatNumber(wordCount);
      }
    }

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function initMarkdownViewer() {
      const backBtn = document.getElementById('backBtn');
      const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
      const copyBtn = document.getElementById('copyBtn');
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      const codeThemeSelect = document.getElementById('codeThemeSelect');
      const markdownViewer = document.getElementById('markdownViewer');
      const markdownSidebar = document.getElementById('markdownSidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');

      // 兼容性事件绑定
      function addEvent(element, event, handler) {
        if (element.addEventListener) {
          element.addEventListener(event, handler);
        } else if (element.attachEvent) {
          element.attachEvent('on' + event, handler);
        }
      }

      addEvent(backBtn, 'click', function () {
        markdownViewer.style.display = 'none';
        resetArticleInfo();
        // 退出护眼模式
        document.body.classList.remove('eye-protection-active');
      });

      addEvent(toggleSidebarBtn, 'click', function () {
        markdownSidebar.classList.toggle('hidden');
      });

      if (sidebarOverlay) {
        addEvent(sidebarOverlay, 'click', function () {
          markdownSidebar.classList.add('hidden');
        });
      }

      // 移动端优化
      if (window.innerWidth <= 768) {
        const markdownContent = document.getElementById('markdownContent');
        if (markdownContent) {
          addEvent(markdownContent, 'click', function (e) {
            if (!markdownSidebar.classList.contains('hidden')) {
              markdownSidebar.classList.add('hidden');
            }
          });
        }
      }

      addEvent(copyBtn, 'click', function () {
        const content = document.getElementById('markdownContent').innerText;
        if (!content || content.trim() === '') {
          showCopyStatus('内容为空，无法复制', false);
          return;
        }

        // 兼容性复制
        if (navigator.clipboard) {
          navigator.clipboard.writeText(content).then(() => {
            showCopyStatus('已复制到剪贴板', true);
          }).catch(err => {
            console.error('复制失败:', err);
            fallbackCopyToClipboard(content, copyBtn);
          });
        } else {
          fallbackCopyToClipboard(content, copyBtn);
        }
      });

      addEvent(codeThemeSelect, 'change', function (e) {
        const theme = e.target.value;
        changeCodeTheme(theme);
        localStorage.setItem('codeTheme', theme);
      });

      const savedTheme = localStorage.getItem('codeTheme') || 'github-dark';
      codeThemeSelect.value = savedTheme;
      changeCodeTheme(savedTheme);

      addEvent(themeToggleBtn, 'click', function () {
        markdownSidebar.classList.remove('hidden');
      });

      // 窗口大小变化监听
      addEvent(window, 'resize', function () {
        if (window.innerWidth > 768) {
          markdownSidebar.classList.remove('hidden');
        }
      });
    }

    function resetArticleInfo() {
      document.getElementById('articleWordCount').textContent = '--';
      document.getElementById('articleLoadTime').textContent = '--';
      document.getElementById('articleReadTime').textContent = '--';
      document.getElementById('articleFileSize').textContent = '--';

      currentArticleStats = null;
    }

    function updateArticleInfo(stats) {
      const articleWordCount = document.getElementById('articleWordCount');
      const articleLoadTime = document.getElementById('articleLoadTime');
      const articleReadTime = document.getElementById('articleReadTime');
      const articleFileSize = document.getElementById('articleFileSize');

      articleWordCount.textContent = formatWordCount(stats.wordCount);
      articleLoadTime.textContent = `${stats.loadTime}ms`;
      articleReadTime.textContent = stats.readTime;
      articleFileSize.textContent = stats.fileSize;
    }

    function showCopyStatus(message, success) {
      const copyBtn = document.getElementById('copyBtn');
      const originalHTML = copyBtn.innerHTML;

      if (success) {
        copyBtn.innerHTML = '<i class="fas fa-check"></i> <span>已复制</span>';
        copyBtn.className = 'action-btn success';
      } else {
        copyBtn.innerHTML = '<i class="fas fa-times"></i> <span>失败</span>';
        copyBtn.className = 'action-btn error';
      }

      setTimeout(() => {
        copyBtn.innerHTML = originalHTML;
        copyBtn.className = 'action-btn';
      }, 2000);
    }

    // 兼容性复制函数
    function fallbackCopyToClipboard(text, button) {
      try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
          showCopyStatus('已复制到剪贴板', true);
        } else {
          showCopyStatus('复制失败，请手动复制', false);
        }
      } catch (err) {
        console.error('备用复制方法失败:', err);
        showCopyStatus('复制失败，请手动复制', false);
      }
    }

    function changeCodeTheme(theme) {
      const links = document.querySelectorAll('link[href*="highlight.js"]');
      if (links.length > 0) {
        const newTheme = theme === 'github' ? 'github.min.css' : `${theme}.min.css`;
        links[0].href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/${newTheme}`;
      }
    }

    async function openArticle(filename, title, articleInfo = null) {
      const markdownViewer = document.getElementById('markdownViewer');
      const markdownTitle = document.getElementById('markdownTitle');
      const markdownContent = document.getElementById('markdownContent');

      if (!filename) {
        console.error('文件名无效:', filename);
        markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>文件错误</h3>
                        <p>文章文件名为空或无效。</p>
                    </div>
                `;
        return;
      }

      const loadStartTime = Date.now();

      // 更新文章信息面板
      currentArticleStats = {
        fileName: filename,
        originalArticle: articleInfo,
        wordCount: articleInfo?.wordCount || 0,
        loadStartTime: loadStartTime,
        loadSuccess: false
      };

      markdownContent.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="loading-spinner"></div><p style="margin-top: 1rem;">加载文章中...</p></div>';
      markdownViewer.style.display = 'flex';
      markdownTitle.textContent = title || '文章阅读';

      // 移动端默认隐藏侧边栏
      if (window.innerWidth <= 768) {
        document.getElementById('markdownSidebar').classList.add('hidden');
      }

      // 应用护眼模式
      if (document.documentElement.getAttribute('data-eye-protection') === 'true') {
        document.body.classList.add('eye-protection-active');
      }

      try {
        // 先获取文件大小以动态调整超时时间
        const headResponse = await safeFetch(`${ARTICLES_BASE_URL}${filename}`, {method: 'HEAD'});
        const fileSize = headResponse.headers ? (headResponse.headers.get('content-length') || 0) : 0;
        const timeout = calculateTimeout(fileSize);

        // 加载文章内容
        const response = await safeFetch(`${ARTICLES_BASE_URL}${filename}`, {
          timeout: timeout
        });

        if (!response.ok) {
          throw new Error(`HTTP错误! 状态: ${response.status}`);
        }

        const markdown = await response.text();
        const loadTime = Date.now() - loadStartTime;

        console.log('加载Markdown成功，长度:', markdown.length);

        // 更新文章统计信息
        const actualFileSize = markdown.length;
        const wordCount = countWords(markdown);
        const readTime = calculateReadTime(wordCount);

        currentArticleStats = {
          ...currentArticleStats,
          wordCount: wordCount,
          loadTime: loadTime,
          readTime: readTime,
          fileSize: formatFileSize(actualFileSize),
          loadSuccess: true
        };

        updateArticleInfo(currentArticleStats);

        // 使用rendermd.js中的renderMarkdown函数
        let renderedHtml = '';
        if (window.renderMarkdown) {
          renderedHtml = window.renderMarkdown(markdown);
        } else {
          renderedHtml = renderSimpleMarkdown(markdown);
        }

        markdownContent.innerHTML = renderedHtml;

        // 为代码块添加事件监听器
        initializeCodeCopyButtons();

        generateTOC();
        if (window.hljs) {
          try {
            hljs.highlightAll();
          } catch (e) {
            console.warn('代码高亮失败:', e);
          }
        }

        // 移动端：优化阅读体验
        if (window.innerWidth <= 768) {
          optimizeMobileReading();
        }

      } catch (error) {
        console.error('加载Markdown失败:', error);

        currentArticleStats = {
          ...currentArticleStats,
          loadSuccess: false,
          loadTime: Date.now() - loadStartTime
        };

        updateArticleInfo(currentArticleStats);

        // 安全地处理文件名中的引号
        const safeFilename = filename.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeTitle = title ? title.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
        const safeArticleInfo = articleInfo ? JSON.stringify(articleInfo).replace(/"/g, '&quot;') : 'null';

        markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>加载失败</h3>
                        <p>无法加载文章内容: ${error.message}</p>
                        <p>文件路径: ${ARTICLES_BASE_URL}${filename}</p>
                        <p>已用时: ${currentArticleStats.loadTime}ms</p>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="openArticle('${safeFilename}', '${safeTitle}', ${safeArticleInfo})" class="action-btn">
                                <i class="fas fa-redo"></i> 重试
                            </button>
                            <button onclick="downloadArticle('${safeFilename}')" class="action-btn">
                                <i class="fas fa-download"></i> 下载原始文件
                            </button>
                        </div>
                    </div>
                `;
      }
    }

    function countWords(text) {
      if (!text) return 0;
      // 移除代码块和HTML标签
      const cleanText = text.replace(/```[\s\S]*?```/g, '')
        .replace(/`[^`]+`/g, '')
        .replace(/<[^>]*>/g, '')
        .replace(/\s+/g, ' ')
        .trim();

      // 中文字符按字计数，英文单词按空格分隔计数
      const chineseChars = cleanText.match(/[\u4e00-\u9fa5]/g) || [];
      const englishWords = cleanText.replace(/[\u4e00-\u9fa5]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 0);

      return chineseChars.length + englishWords.length;
    }

    function calculateReadTime(wordCount) {
      const wordsPerMinute = 300; // 平均阅读速度
      const minutes = Math.ceil(wordCount / wordsPerMinute);

      if (minutes < 1) return '<1分钟';
      if (minutes < 60) return `${minutes}分钟`;

      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;

      if (remainingMinutes === 0) return `${hours}小时`;
      return `${hours}小时${remainingMinutes}分钟`;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // 简单的markdown渲染函数 - 备用方案
    function renderSimpleMarkdown(markdown) {
      if (!markdown || typeof markdown !== 'string') {
        return '<p>内容为空</p>';
      }

      // 安全的HTML转义
      function escapeHtml(text) {
        if (typeof text !== 'string') text = String(text);
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function (m) {return map[m];});
      }

      let html = markdown;

      // 首先处理代码块
      html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function (match, lang, code) {
        const languageName = getLanguageName(lang);
        const escapedCode = escapeHtml(code);

        return `
                    <div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">${languageName}</span>
                            <button class="copy-code-btn">
                                <i class="far fa-copy"></i><span>复制</span>
                            </button>
                        </div>
                        <pre><code class="${lang || ''}">${escapedCode}</code></pre>
                    </div>
                `;
      });

      // 转换标题
      html = html
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$2</h2>')
        .replace(/^### (.*$)/gm, '<h3>$3</h3>')
        .replace(/^#### (.*$)/gm, '<h4>$4</h4>')
        .replace(/^##### (.*$)/gm, '<h5>$5</h5>')
        .replace(/^###### (.*$)/gm, '<h6>$6</h6>')
        // 转换加粗
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<strong>$1</strong>')
        // 转换斜体
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        // 转换行内代码
        .replace(/`([^`]+)`/g, function (match, code) {
          if (code.length > 10) {
            return `
                            <span class="code-inline-wrapper">
                                <code>${escapeHtml(code)}</code>
                                <button class="inline-copy-btn">
                                    <i class="far fa-copy"></i>
                                </button>
                            </span>
                        `;
          }
          return `<code>${escapeHtml(code)}</code>`;
        })
        // 转换链接
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, function (match, text, href) {
          const escapedText = escapeHtml(text);
          const escapedHref = escapeHtml(href);
          if (href.startsWith('http://') || href.startsWith('https://')) {
            return `<a href="${escapedHref}" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
          }
          return `<a href="${escapedHref}">${escapedText}</a>`;
        })
        // 转换图片
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function (match, alt, src) {
          const escapedAlt = escapeHtml(alt);
          const escapedSrc = escapeHtml(src);
          return `<img src="${escapedSrc}" alt="${escapedAlt}" style="max-width: 100%; height: auto;">`;
        })
        // 转换列表
        .replace(/^\s*\*\s+(.*$)/gm, '<li>$1</li>')
        .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
        .replace(/^\s*\+\s+(.*$)/gm, '<li>$1</li>')
        // 转换引用
        .replace(/^>\s*(.*$)/gm, '<blockquote>$1</blockquote>')
        // 转换段落
        .replace(/\n\n+/g, '</p><p>')
        .replace(/^([^<\n].*)/gm, '<p>$1</p>');

      // 处理列表
      html = html.replace(/<li>.*?<\/li>/g, function (match) {
        if (!match.includes('</ul>') && !match.includes('</ol>')) {
          return '<ul>' + match + '</ul>';
        }
        return match;
      });

      return html;
    }

    // 获取语言名称
    function getLanguageName(lang) {
      if (!lang) return '代码';

      const languageMap = {
        'js': 'JavaScript', 'javascript': 'JavaScript',
        'py': 'Python', 'python': 'Python',
        'lua': 'Lua', 'html': 'HTML', 'css': 'CSS',
        'json': 'JSON', 'xml': 'XML', 'bash': 'Bash',
        'sh': 'Shell', 'md': 'Markdown', 'cpp': 'C++',
        'c': 'C', 'java': 'Java', 'php': 'PHP',
        'ruby': 'Ruby', 'go': 'Go', 'rust': 'Rust',
        'ts': 'TypeScript', 'typescript': 'TypeScript',
        'sql': 'SQL', 'yaml': 'YAML', 'yml': 'YAML',
        'txt': 'Text', 'plaintext': 'Text'
      };

      return languageMap[lang.toLowerCase()] || lang.charAt(0).toUpperCase() + lang.slice(1);
    }

    // 初始化代码复制按钮
    function initializeCodeCopyButtons() {
      // 为代码块添加事件监听器
      const codeBlocks = document.querySelectorAll('.code-block-wrapper');
      codeBlocks.forEach(wrapper => {
        const copyBtn = wrapper.querySelector('.copy-code-btn');
        if (copyBtn) {
          copyBtn.onclick = null;
          copyBtn.addEventListener('click', function () {
            const codeElement = wrapper.querySelector('code');
            if (codeElement) {
              const text = codeElement.textContent;
              if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                  showCopySuccess(this, false);
                }).catch(() => {
                  fallbackCopyToClipboard(text, this);
                });
              } else {
                fallbackCopyToClipboard(text, this);
              }
            }
          });
        }
      });

      // 为内联代码添加事件监听器
      const inlineCodeWrappers = document.querySelectorAll('.code-inline-wrapper');
      inlineCodeWrappers.forEach(wrapper => {
        const copyBtn = wrapper.querySelector('.inline-copy-btn');
        if (copyBtn) {
          copyBtn.onclick = null;
          copyBtn.addEventListener('click', function () {
            const codeElement = wrapper.querySelector('code');
            let codeText = '';

            if (codeElement) {
              codeText = codeElement.textContent;
            }

            if (codeText) {
              if (navigator.clipboard) {
                navigator.clipboard.writeText(codeText).then(() => {
                  showCopySuccess(this, true);
                }).catch(() => {
                  showCopyError(this, true);
                });
              } else {
                showCopyError(this, true);
              }
            } else {
              showCopyError(this, true);
            }
          });
        }
      });
    }

    // 显示复制成功状态
    function showCopySuccess(button, isInline) {
      if (isInline) {
        const originalHTML = button.innerHTML;
        const originalColor = button.style.color;

        button.innerHTML = '<i class="fas fa-check"></i>';
        button.style.color = '#00ff00';

        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.style.color = originalColor || '';
        }, 2000);
      } else {
        const originalHTML = button.innerHTML;
        const originalClass = button.className;

        button.innerHTML = '<i class="fas fa-check"></i><span>已复制</span>';
        button.className = originalClass + ' success';

        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.className = originalClass;
        }, 2000);
      }
    }

    // 显示复制错误状态
    function showCopyError(button, isInline) {
      if (isInline) {
        const originalHTML = button.innerHTML;
        const originalColor = button.style.color;

        button.innerHTML = '<i class="fas fa-times"></i>';
        button.style.color = '#ff0000';

        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.style.color = originalColor || '';
        }, 2000);
      } else {
        const originalHTML = button.innerHTML;
        const originalClass = button.className;

        button.innerHTML = '<i class="fas fa-times"></i><span>失败</span>';
        button.className = originalClass + ' error';

        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.className = originalClass;
        }, 2000);
      }
    }

    // 移动端阅读优化
    function optimizeMobileReading() {
      const content = document.getElementById('markdownContent');

      // 为代码块添加移动端优化
      const codeBlocks = content.querySelectorAll('pre');
      codeBlocks.forEach(block => {
        block.style.overflowX = 'auto';
        block.style.WebkitOverflowScrolling = 'touch';
        block.style.maxWidth = '100%';
      });

      // 为表格添加滚动
      const tables = content.querySelectorAll('table');
      tables.forEach(table => {
        const wrapper = document.createElement('div');
        wrapper.style.overflowX = 'auto';
        wrapper.style.WebkitOverflowScrolling = 'touch';
        wrapper.style.margin = '1rem 0';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
      });

      // 调整图片大小
      const images = content.querySelectorAll('img');
      images.forEach(img => {
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
      });
    }

    function generateTOC() {
      const content = document.getElementById('markdownContent');
      const tocList = document.getElementById('tocList');
      const headings = content.querySelectorAll('h1, h2, h3, h4');

      tocList.innerHTML = '';

      if (headings.length === 0) {
        tocList.innerHTML = '<li class="toc-item"><span class="toc-link">暂无目录</span></li>';
        return;
      }

      headings.forEach((heading, index) => {
        if (!heading.id) {
          heading.id = 'heading-' + index;
        }

        const level = parseInt(heading.tagName.substring(1));
        const listItem = document.createElement('li');
        listItem.className = 'toc-item toc-level-' + level;

        const link = document.createElement('a');
        link.href = '#' + heading.id;
        link.className = 'toc-link';
        link.textContent = heading.textContent;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          try {
            heading.scrollIntoView({behavior: 'smooth'});
          } catch (e) {
            heading.scrollIntoView();
          }

          if (window.innerWidth <= 768) {
            document.getElementById('markdownSidebar').classList.add('hidden');
          }
        });

        listItem.appendChild(link);
        tocList.appendChild(listItem);
      });
    }

    function downloadArticle(filename) {
      if (!filename) {
        alert('文件名无效，无法下载');
        return;
      }

      const link = document.createElement('a');
      link.href = ARTICLES_BASE_URL + filename;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function initThemeSwitcher() {
      const themeSwitcher = document.getElementById('themeSwitcher');
      const themeIcon = document.getElementById('themeIcon');
      const html = document.documentElement;

      const savedTheme = localStorage.getItem('theme') || 'dark';
      html.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      // 兼容性事件绑定
      if (themeSwitcher.addEventListener) {
        themeSwitcher.addEventListener('click', toggleTheme);
      } else if (themeSwitcher.attachEvent) {
        themeSwitcher.attachEvent('onclick', toggleTheme);
      }

      function toggleTheme() {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);

        themeSwitcher.style.transform = 'scale(0.9)';
        setTimeout(() => {
          themeSwitcher.style.transform = '';
        }, 200);
      }

      function updateThemeIcon(theme) {
        if (theme === 'dark') {
          themeIcon.className = 'fas fa-moon';
        } else {
          themeIcon.className = 'fas fa-sun';
        }
      }
    }

    function initBackgroundToggle() {
      const bgToggle = document.getElementById('bgToggle');
      const bgContainer = document.getElementById('bgContainer');

      const bgVisible = localStorage.getItem('bgVisible') !== 'false';
      updateBackgroundVisibility(bgVisible);

      // 兼容性事件绑定
      function addBgToggleEvent() {
        if (bgToggle.addEventListener) {
          bgToggle.addEventListener('click', toggleBackground);
        } else if (bgToggle.attachEvent) {
          bgToggle.attachEvent('onclick', toggleBackground);
        }
      }

      addBgToggleEvent();

      function toggleBackground() {
        const isVisible = bgContainer.style.opacity !== '0';
        updateBackgroundVisibility(!isVisible);
        localStorage.setItem('bgVisible', !isVisible);

        const icon = bgToggle.querySelector('i');
        if (!isVisible) {
          icon.className = 'fas fa-eye';
          bgToggle.title = '隐藏背景';
        } else {
          icon.className = 'fas fa-eye-slash';
          bgToggle.title = '显示背景';
        }
      }

      function updateBackgroundVisibility(visible) {
        if (visible) {
          bgContainer.style.opacity = '1';
          bgToggle.title = '隐藏背景';
          bgToggle.querySelector('i').className = 'fas fa-eye';
        } else {
          bgContainer.style.opacity = '0';
          bgToggle.title = '显示背景';
          bgToggle.querySelector('i').className = 'fas fa-eye-slash';
        }
      }
    }

    // 键盘快捷键 - 兼容性处理
    function addKeyboardShortcuts() {
      function addKeyEvent(event, handler) {
        if (document.addEventListener) {
          document.addEventListener(event, handler);
        } else if (document.attachEvent) {
          document.attachEvent('on' + event, handler);
        }
      }

      addKeyEvent('keydown', function (e) {
        if (!e) e = window.event;

        if (e.altKey && e.key === 't') {
          document.getElementById('themeSwitcher').click();
        }
        if (e.altKey && e.key === 'b') {
          document.getElementById('bgToggle').click();
        }
        if (e.altKey && e.key === 'h') {
          window.location.href = 'index.html';
        }
        if (e.key === 'Escape') {
          const markdownViewer = document.getElementById('markdownViewer');
          if (markdownViewer.style.display === 'flex') {
            document.getElementById('backBtn').click();
          }
        }
        if (e.altKey && e.key === 'r') {
          loadArticles();
        }
        // 护眼模式快捷键：Alt+E
        if (e.altKey && e.key === 'e') {
          document.getElementById('eyeProtectionToggle').click();
        }
        // 搜索快捷键：Ctrl+F 或 Cmd+F
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          document.getElementById('searchInput').focus();
          document.getElementById('searchInput').select();
        }
      });
    }

    // 初始化键盘快捷键
    addKeyboardShortcuts();
  </script>
</body>

</html>