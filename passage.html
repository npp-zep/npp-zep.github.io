<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>文章导航 —— npp-zep</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/passage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/206399566?v=4">
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="bg-container" id="bgContainer">
        <div class="bg-overlay"></div>
        <img src="assets/pic/bg.png" alt="背景" class="bg-image" id="bgImage">
        <button class="bg-toggle" id="bgToggle" title="切换背景显示">
            <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="container">
        <header>
            <h1>文章导航
                <small>知识分享 · 学习笔记</small>
            </h1>
            <p class="tagline">记录思考，分享见解</p>
        </header>

        <main class="main-content">
            <section class="description">
                <div class="profile-header">
                    <img src="https://avatars.githubusercontent.com/u/206399566?v=4" alt="头像" class="avatar">
                    <h2>我的文章</h2>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-info-circle"></i> 说明</h3>
                    <p>这里是我在学习过程中整理的笔记和心得分享，内容涵盖编程技术、学习方法和项目经验等。所有文章都以Markdown格式编写，支持代码高亮和目录导航。</p>
                    
                    <h3><i class="fas fa-filter"></i> 筛选文章</h3>
                    <div class="filter-section">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">全部文章</button>
                            <button class="filter-btn" data-filter="web">Web开发</button>
                            <button class="filter-btn" data-filter="lua">Lua开发</button>
                            <button class="filter-btn" data-filter="python">Python</button>
                            <button class="filter-btn" data-filter="tutorial">教程</button>
                            <button class="filter-btn" data-filter="note">笔记</button>
                            <button class="filter-btn" data-filter="project">项目</button>
                            <button class="filter-btn" data-filter="document">文档</button>
                            <button class="filter-btn" data-filter="api">API文档</button>
                            <button class="filter-btn" data-filter="guide">指南</button>
                        </div>
                    </div>
                </div>

                <div class="articles-section">
                    <h3><i class="fas fa-book-open"></i> 文章列表</h3>
                    <div class="articles-list" id="articlesList">
                        <div class="loading-articles">
                            <div class="loading-spinner"></div>
                            <p>正在加载文章列表...</p>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="cta-section">
                <a href="index.html" class="btn">
                    <i class="fas fa-home"></i> 返回首页
                </a>
                
                <a href="https://github.com/npp-zep" target="_blank" class="btn">
                    <i class="fab fa-github"></i> GitHub 主页
                </a>
                
                <div class="quick-links">
                    <h4>快速链接</h4>
                    <a href="#articles" class="quick-link">查看文章</a>
                    <a href="#about" class="quick-link">关于本站</a>
                    <a href="https://github.com/npp-zep/npp-zep.github.io" target="_blank" class="quick-link">源代码</a>
                </div>
                
                <div class="stats-section" id="statsSection">
                </div>
            </aside>
        </main>

        <footer>
            <p>遵循 <a href="https://opensource.org/licenses/MIT" target="_blank" class="license-link">MIT 协议</a></p>
            <p class="footer-note">文章内容采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议</p>
        </footer>
    </div>

    <!-- 工具栏界面 -->
    <div class="toolbar-sidebar" id="toolbarSidebar">
        <div class="toolbar-header">
            <h3><i class="fas fa-palette"></i> 工具栏</h3>
            <button class="close-toolbar" id="closeToolbar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
            <div class="toolbar-section">
                <h4><i class="fas fa-code"></i> 代码高亮支持</h4>
                <div class="language-support" id="languageSupport">
                    <div class="loading-languages">
                        <div class="loading-spinner"></div>
                        <p>检测支持的语言...</p>
                    </div>
                </div>
            </div>
            
            <div class="toolbar-section">
                <h4><i class="fas fa-tools"></i> 工具设置</h4>
                <div class="tool-settings">
                    <div class="tool-item">
                        <label>
                            <input type="checkbox" id="autoHighlight" checked>
                            自动代码高亮
                        </label>
                    </div>
                    <div class="tool-item">
                        <label>
                            <input type="checkbox" id="smoothScroll" checked>
                            平滑滚动
                        </label>
                    </div>
                    <div class="tool-item">
                        <label>
                            <input type="checkbox" id="copyConfirm" checked>
                            复制确认提示
                        </label>
                    </div>
                    <div class="tool-item">
                        <label for="loadTimeout">加载超时(秒)</label>
                        <input type="range" id="loadTimeout" min="5" max="60" value="30">
                        <span id="timeoutValue">30s</span>
                    </div>
                </div>
            </div>
            
            <div class="toolbar-section">
                <h4><i class="fas fa-info-circle"></i> 系统信息</h4>
                <div class="system-info">
                    <p>文章总数: <span id="totalArticlesInfo">0</span></p>
                    <p>总字数: <span id="totalWordsInfo">0</span></p>
                    <p>当前主题: <span id="currentTheme">dark</span></p>
                    <p>支持语言: <span id="languageCount">0</span>种</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 工具栏遮罩 -->
    <div class="toolbar-overlay" id="toolbarOverlay"></div>
    
    <!-- 工具栏按钮 -->
    <button class="toolbar-toggle" id="toolbarToggle" title="工具栏">
        <i class="fas fa-sliders-h"></i>
    </button>

    <div class="markdown-viewer" id="markdownViewer">
        <div class="markdown-header">
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i> <span class="back-text">返回</span>
            </button>
            <h2 class="markdown-title" id="markdownTitle"></h2>
            <div class="markdown-actions">
                <button class="action-btn" id="toggleSidebarBtn">
                    <i class="fas fa-bars"></i> <span>目录</span>
                </button>
                <button class="action-btn" id="themeToggleBtn">
                    <i class="fas fa-palette"></i> <span>主题</span>
                </button>
                <button class="action-btn" id="copyBtn">
                    <i class="far fa-copy"></i> <span>复制</span>
                </button>
                <button class="action-btn" id="wordCountBtn" title="字数统计">
                    <i class="fas fa-file-word"></i> <span>字数</span>
                </button>
            </div>
        </div>
        
        <div class="markdown-container">
            <div class="markdown-sidebar" id="markdownSidebar">
                <h3 class="toc-title"><i class="fas fa-list"></i> 目录</h3>
                <ul class="toc-list" id="tocList">
                </ul>
                
                <div class="theme-options">
                    <h4><i class="fas fa-palette"></i> 代码主题</h4>
                    <select class="theme-select" id="codeThemeSelect">
                        <option value="github-dark">GitHub Dark</option>
                        <option value="github">GitHub Light</option>
                        <option value="vs2015">VS 2015</option>
                        <option value="atom-one-dark">Atom One Dark</option>
                        <option value="monokai">Monokai</option>
                        <option value="solarized-dark">Solarized Dark</option>
                    </select>
                </div>
                
                <div class="article-stats">
                    <h4><i class="fas fa-chart-bar"></i> 文章统计</h4>
                    <div class="stats-info">
                        <p>字数: <span id="articleWordCount">0</span></p>
                        <p>阅读时间: <span id="articleReadTime">0</span>分钟</p>
                        <p>段落: <span id="articleParagraphs">0</span></p>
                        <p>代码块: <span id="articleCodeBlocks">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- 侧边栏遮罩层 -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <div class="markdown-content" id="markdownContent">
            </div>
        </div>
    </div>

    <button class="theme-switcher" id="themeSwitcher">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- 引入highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/markdown.min.js"></script>
    <!-- 更多语言支持 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/dockerfile.min.js"></script>
    
    <!-- 引入marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- 引入修复后的rendermd.js -->
    <script src="script/rendermd.js"></script>
    
    <!-- 主脚本 -->
    <script>
        const ARTICLES_CONFIG_URL = 'assets/passage/articles.json';
        const ARTICLES_BASE_URL = 'assets/passage/';
        const LOAD_TIMEOUT_DEFAULT = 30000; // 30秒超时
        let allArticles = [];
        let currentLoadTimeout = LOAD_TIMEOUT_DEFAULT;
        let supportedLanguages = new Set();
        let isToolbarOpen = false;

        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
            }, 800);
            
            initToolbar();
            loadArticles();
            initThemeSwitcher();
            initBackgroundToggle();
            initMarkdownViewer();
            detectSupportedLanguages();
        });

        // 初始化工具栏
        function initToolbar() {
            const toolbarToggle = document.getElementById('toolbarToggle');
            const closeToolbar = document.getElementById('closeToolbar');
            const toolbarOverlay = document.getElementById('toolbarOverlay');
            const colorInputs = document.querySelectorAll('.color-picker-section input[type="color"]');
            const resetColorsBtn = document.getElementById('resetColors');
            const saveColorsBtn = document.getElementById('saveColors');
            const loadTimeoutSlider = document.getElementById('loadTimeout');
            const timeoutValue = document.getElementById('timeoutValue');

            // 工具栏显示/隐藏
            toolbarToggle.addEventListener('click', toggleToolbar);
            closeToolbar.addEventListener('click', closeToolbarHandler);
            toolbarOverlay.addEventListener('click', closeToolbarHandler);

            // 颜色设置
            loadColorSettings();
            
            colorInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    updateColorPreview(e.target);
                });
                
                input.addEventListener('change', (e) => {
                    updateColorPreview(e.target);
                });
            });

            resetColorsBtn.addEventListener('click', resetColors);
            saveColorsBtn.addEventListener('click', saveColorSettings);

            // 超时设置
            loadTimeoutSlider.addEventListener('input', (e) => {
                const value = e.target.value;
                timeoutValue.textContent = value + 's';
                currentLoadTimeout = value * 1000;
                localStorage.setItem('loadTimeout', currentLoadTimeout);
            });

            // 加载保存的超时设置
            const savedTimeout = localStorage.getItem('loadTimeout');
            if (savedTimeout) {
                currentLoadTimeout = parseInt(savedTimeout);
                loadTimeoutSlider.value = currentLoadTimeout / 1000;
                timeoutValue.textContent = (currentLoadTimeout / 1000) + 's';
            }

            // 工具设置
            const autoHighlight = document.getElementById('autoHighlight');
            const smoothScroll = document.getElementById('smoothScroll');
            const copyConfirm = document.getElementById('copyConfirm');

            // 加载保存的设置
            loadToolSettings();

            // 保存设置
            [autoHighlight, smoothScroll, copyConfirm].forEach(checkbox => {
                checkbox.addEventListener('change', saveToolSettings);
            });

            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.key === 'p') {
                    toggleToolbar();
                }
            });
        }

        function toggleToolbar() {
            const toolbar = document.getElementById('toolbarSidebar');
            const overlay = document.getElementById('toolbarOverlay');
            
            isToolbarOpen = !isToolbarOpen;
            
            if (isToolbarOpen) {
                toolbar.classList.add('active');
                overlay.classList.add('active');
                updateSystemInfo();
            } else {
                toolbar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

        function closeToolbarHandler() {
            const toolbar = document.getElementById('toolbarSidebar');
            const overlay = document.getElementById('toolbarOverlay');
            
            toolbar.classList.remove('active');
            overlay.classList.remove('active');
            isToolbarOpen = false;
        }

        function loadColorSettings() {
            const colorSettings = JSON.parse(localStorage.getItem('colorSettings') || '{}');
            
            if (Object.keys(colorSettings).length > 0) {
                Object.entries(colorSettings).forEach(([key, value]) => {
                    const input = document.querySelector(`input[data-theme-key="${key}"]`);
                    if (input) {
                        input.value = value;
                        updateColorPreview(input);
                    }
                });
            }
        }

        function updateColorPreview(input) {
            const key = input.dataset.themeKey;
            const value = input.value;
            
            // 更新CSS变量
            document.documentElement.style.setProperty(`--${key}`, value);
        }

        function resetColors() {
            const defaultColors = {
                'primary-color': '#0a192f',
                'highlight-color': '#64ffda',
                'accent-color': '#ff6b6b',
                'text-color': '#e6f1ff'
            };
            
            Object.entries(defaultColors).forEach(([key, value]) => {
                const input = document.querySelector(`input[data-theme-key="${key}"]`);
                if (input) {
                    input.value = value;
                    updateColorPreview(input);
                }
            });
            
            // 保存默认设置
            localStorage.setItem('colorSettings', JSON.stringify(defaultColors));
            
            showNotification('颜色已重置为默认值', 'success');
        }

        function saveColorSettings() {
            const colorSettings = {};
            const colorInputs = document.querySelectorAll('.color-picker-section input[type="color"]');
            
            colorInputs.forEach(input => {
                const key = input.dataset.themeKey;
                const value = input.value;
                colorSettings[key] = value;
            });
            
            localStorage.setItem('colorSettings', JSON.stringify(colorSettings));
            showNotification('颜色设置已保存', 'success');
        }

        function loadToolSettings() {
            const toolSettings = JSON.parse(localStorage.getItem('toolSettings') || '{}');
            
            const autoHighlight = document.getElementById('autoHighlight');
            const smoothScroll = document.getElementById('smoothScroll');
            const copyConfirm = document.getElementById('copyConfirm');
            
            if (toolSettings.autoHighlight !== undefined) {
                autoHighlight.checked = toolSettings.autoHighlight;
            }
            
            if (toolSettings.smoothScroll !== undefined) {
                smoothScroll.checked = toolSettings.smoothScroll;
            }
            
            if (toolSettings.copyConfirm !== undefined) {
                copyConfirm.checked = toolSettings.copyConfirm;
            }
        }

        function saveToolSettings() {
            const toolSettings = {
                autoHighlight: document.getElementById('autoHighlight').checked,
                smoothScroll: document.getElementById('smoothScroll').checked,
                copyConfirm: document.getElementById('copyConfirm').checked
            };
            
            localStorage.setItem('toolSettings', JSON.stringify(toolSettings));
        }

        function detectSupportedLanguages() {
            const languageSupport = document.getElementById('languageSupport');
            
            if (typeof hljs === 'undefined') {
                languageSupport.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>highlight.js未加载</p>
                    </div>
                `;
                return;
            }
            
            try {
                // 获取highlight.js支持的语言列表
                const languages = hljs.listLanguages();
                supportedLanguages = new Set(languages);
                
                // 分组显示语言
                const languageGroups = {
                    'Web开发': ['javascript', 'html', 'css', 'typescript', 'json', 'xml'],
                    '后端语言': ['python', 'java', 'php', 'ruby', 'go', 'rust', 'c', 'cpp', 'csharp'],
                    '脚本语言': ['bash', 'shell', 'powershell', 'lua'],
                    '数据相关': ['sql', 'yaml', 'toml', 'ini'],
                    '配置语言': ['dockerfile', 'makefile', 'nginx'],
                    '文档语言': ['markdown', 'latex', 'plaintext']
                };
                
                let html = '';
                Object.entries(languageGroups).forEach(([groupName, langList]) => {
                    const availableLangs = langList.filter(lang => supportedLanguages.has(lang));
                    
                    if (availableLangs.length > 0) {
                        html += `
                            <div class="language-group">
                                <h5>${groupName}</h5>
                                <div class="language-tags">
                                    ${availableLangs.map(lang => `
                                        <span class="language-tag" title="${lang}">
                                            ${getLanguageName(lang)}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                // 统计总数
                const totalCount = languages.length;
                const displayCount = Math.min(totalCount, 50); // 只显示前50个
                
                html += `
                    <div class="language-stats">
                        <p>共支持 <strong>${totalCount}</strong> 种语言 (显示${displayCount}种常用语言)</p>
                    </div>
                `;
                
                languageSupport.innerHTML = html;
                
                // 更新系统信息
                updateLanguageCount();
                
            } catch (error) {
                console.error('检测支持的语言失败:', error);
                languageSupport.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>检测语言支持失败: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateLanguageCount() {
            const languageCount = document.getElementById('languageCount');
            if (languageCount) {
                languageCount.textContent = supportedLanguages.size;
            }
        }

        function updateSystemInfo() {
            const totalArticlesInfo = document.getElementById('totalArticlesInfo');
            const totalWordsInfo = document.getElementById('totalWordsInfo');
            const currentTheme = document.getElementById('currentTheme');
            const languageCount = document.getElementById('languageCount');
            
            if (totalArticlesInfo) {
                totalArticlesInfo.textContent = allArticles.length;
            }
            
            if (totalWordsInfo) {
                const totalWords = allArticles.reduce((sum, article) => {
                    return sum + (parseInt(article.wordCount) || 0);
                }, 0);
                totalWordsInfo.textContent = formatWordCount(totalWords);
            }
            
            if (currentTheme) {
                currentTheme.textContent = document.documentElement.getAttribute('data-theme');
            }
            
            if (languageCount) {
                languageCount.textContent = supportedLanguages.size;
            }
        }

        function formatWordCount(count) {
            if (count >= 10000) {
                return (count / 10000).toFixed(1) + '万';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + '千';
            }
            return count;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // 动画效果
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);
            
            // 3秒后消失
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        async function loadArticles() {
            const articlesList = document.getElementById('articlesList');
            
            try {
                articlesList.innerHTML = `
                    <div class="loading-articles">
                        <div class="loading-spinner"></div>
                        <p>正在加载文章列表...</p>
                    </div>
                `;
                
                console.log('正在加载文章配置文件:', ARTICLES_CONFIG_URL);
                
                // 设置超时控制器
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    throw new Error(`加载超时 (${currentLoadTimeout/1000}秒)`);
                }, currentLoadTimeout);
                
                const response = await fetch(ARTICLES_CONFIG_URL, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    cache: 'no-cache',
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status} - ${response.statusText}`);
                }
                
                const jsonText = await response.text();
                console.log('原始JSON数据:', jsonText.substring(0, 500) + '...');
                
                const cleanJsonText = jsonText.trim().replace(/^\uFEFF/, '');
                const articlesData = JSON.parse(cleanJsonText);
                
                allArticles = articlesData.articles || [];
                
                if (!Array.isArray(allArticles) || allArticles.length === 0) {
                    throw new Error('文章数据格式错误或为空');
                }
                
                // 清理和验证文章数据
                allArticles = cleanArticlesData(allArticles);
                
                articlesList.innerHTML = '';
                
                allArticles.forEach((article, index) => {
                    console.log(`处理文章 ${index + 1}:`, {
                        title: article.title,
                        description: article.description,
                        wordCount: article.wordCount,
                        descriptionType: typeof article.description
                    });
                    
                    const articleElement = createArticleCard(article);
                    articlesList.appendChild(articleElement);
                });
                
                updateStats();
                updateSystemInfo();
                initFilter();
                
                console.log('成功加载', allArticles.length, '篇文章');
                
            } catch (error) {
                console.error('加载文章失败:', error);
                showError('无法加载文章列表', error.message);
                
                // 显示重试按钮
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>加载失败</h3>
                    <p>${error.message}</p>
                    <p style="font-size: 0.85rem; margin-top: 1rem;">当前超时设置: ${currentLoadTimeout/1000}秒</p>
                    <div style="margin-top: 1rem;">
                        <button onclick="loadArticles()" class="article-btn">
                            <i class="fas fa-redo"></i> 重试加载
                        </button>
                        <button onclick="increaseTimeout()" class="article-btn">
                            <i class="fas fa-clock"></i> 增加超时时间
                        </button>
                    </div>
                `;
                
                articlesList.innerHTML = '';
                articlesList.appendChild(errorDiv);
            }
        }

        function increaseTimeout() {
            currentLoadTimeout += 10000; // 增加10秒
            const loadTimeoutSlider = document.getElementById('loadTimeout');
            const timeoutValue = document.getElementById('timeoutValue');
            
            loadTimeoutSlider.value = currentLoadTimeout / 1000;
            timeoutValue.textContent = (currentLoadTimeout / 1000) + 's';
            
            showNotification(`超时时间已增加至${currentLoadTimeout/1000}秒`, 'info');
            loadArticles();
        }

        // 清理和验证文章数据
        function cleanArticlesData(articles) {
            return articles.map(article => {
                const cleaned = {};
                
                // 确保所有字段都是字符串
                cleaned.title = String(article.title || '无标题');
                cleaned.date = String(article.date || '未知日期');
                cleaned.readTime = String(article.readTime || '未知');
                cleaned.description = String(article.description || '暂无描述');
                cleaned.file = String(article.file || '');
                cleaned.wordCount = parseInt(article.wordCount) || 0;
                
                // 处理tags - 确保是数组
                if (Array.isArray(article.tags)) {
                    cleaned.tags = article.tags.map(tag => String(tag));
                } else if (typeof article.tags === 'string') {
                    // 处理逗号分隔的标签字符串
                    cleaned.tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                } else {
                    cleaned.tags = [];
                }
                
                // 额外的安全检查和清理
                if (cleaned.description === '[object Object]') {
                    console.warn('检测到 [object Object] 描述，替换为默认描述');
                    cleaned.description = '暂无描述';
                }
                
                // 清理描述中的特殊字符
                if (cleaned.description && cleaned.description.includes('[project]')) {
                    console.warn('检测到特殊描述模式，进行清理:', cleaned.description);
                    cleaned.description = cleaned.description.replace(/\[project\]\s*:\s*project/g, '项目说明');
                }
                
                return cleaned;
            });
        }

        function showError(title, message) {
            const articlesList = document.getElementById('articlesList');
            
            articlesList.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <p style="font-size: 0.85rem; margin-top: 1rem;">请检查文件路径是否正确，并确保 <code>articles.json</code> 文件存在。</p>
                    <button onclick="loadArticles()" class="article-btn" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> 重试加载
                    </button>
                </div>
            `;
            
            document.getElementById('statsSection').innerHTML = '';
        }

        function createArticleCard(article) {
            const articleCard = document.createElement('div');
            articleCard.className = 'article-card';
            
            // 确保tags是字符串数组
            const tagsArray = Array.isArray(article.tags) ? article.tags : 
                            (typeof article.tags === 'string' ? 
                             article.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []);
            
            articleCard.dataset.tags = tagsArray.join(' ');
            
            const tagsHtml = tagsArray.map(tag => 
                `<span class="article-tag tag-${tag.toLowerCase()}">${tag}</span>`
            ).join('');
            
            // 使用事件监听器而不是onclick属性，避免转义问题
            const safeFile = article.file || '';
            const safeTitle = article.title || '无标题';
            const safeDescription = article.description || '暂无描述';
            const wordCount = article.wordCount || 0;
            const wordCountText = wordCount > 0 ? ` · ${formatWordCount(wordCount)}字` : '';
            
            // 双重检查，防止 [object Object]
            const finalDescription = typeof safeDescription === 'object' ? '暂无描述' : safeDescription;
            
            articleCard.innerHTML = `
                <div class="article-header">
                    <h4 class="article-title">${article.title || '无标题'}</h4>
                    <div class="article-meta">
                        <span class="article-date"><i class="far fa-calendar"></i> ${article.date || '未知日期'}</span>
                        <span class="article-read-time"><i class="far fa-clock"></i> ${article.readTime || '未知'}</span>
                        ${wordCount > 0 ? `<span class="article-word-count"><i class="fas fa-file-word"></i> ${formatWordCount(wordCount)}字</span>` : ''}
                    </div>
                </div>
                <p class="article-description">${finalDescription}</p>
                <div class="article-footer">
                    <div class="article-tags">
                        ${tagsHtml}
                    </div>
                    <div class="article-actions">
                        <button class="article-btn read-btn">
                            <i class="fas fa-book-open"></i> 阅读
                        </button>
                        <button class="article-btn download-btn">
                            <i class="fas fa-download"></i> 下载
                        </button>
                        ${wordCount > 0 ? `<button class="article-btn wordcount-btn" title="字数统计">
                            <i class="fas fa-chart-bar"></i>
                        </button>` : ''}
                    </div>
                </div>
            `;
            
            // 使用事件委托添加点击事件
            const readBtn = articleCard.querySelector('.read-btn');
            const downloadBtn = articleCard.querySelector('.download-btn');
            const wordcountBtn = articleCard.querySelector('.wordcount-btn');
            
            readBtn.addEventListener('click', () => {
                openArticle(safeFile, safeTitle);
            });
            
            downloadBtn.addEventListener('click', () => {
                downloadArticle(safeFile);
            });
            
            if (wordcountBtn) {
                wordcountBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showWordCountInfo(article);
                });
            }
            
            return articleCard;
        }

        function showWordCountInfo(article) {
            const wordCount = article.wordCount || 0;
            const readTime = article.readTime || '未知';
            
            showNotification(
                `"${article.title}"\n字数: ${wordCount}字\n阅读时间: ${readTime}分钟`,
                'info'
            );
        }

        function initFilter() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            const articlesList = document.getElementById('articlesList');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    const articleCards = document.querySelectorAll('.article-card');
                    
                    articleCards.forEach(card => {
                        if (filter === 'all' || card.dataset.tags.includes(filter)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    articlesList.style.opacity = '0.5';
                    setTimeout(() => {
                        articlesList.style.opacity = '1';
                    }, 300);
                });
            });
        }

        function updateStats() {
            const statsSection = document.getElementById('statsSection');
            
            if (!allArticles || allArticles.length === 0) {
                statsSection.innerHTML = '';
                return;
            }
            
            const totalArticles = allArticles.length;
            const totalWords = allArticles.reduce((sum, article) => sum + (parseInt(article.wordCount) || 0), 0);
            
            // 计算各类别文章数量
            const webArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('web') || tag.toLowerCase() === 'web'
            )).length;
            
            const luaArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('lua') || tag.toLowerCase() === 'lua'
            )).length;
            
            const pythonArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('python') || tag.toLowerCase() === 'python'
            )).length;
            
            const tutorialArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('tutorial') || tag.toLowerCase() === 'tutorial'
            )).length;
            
            const noteArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('note') || tag.toLowerCase() === 'note'
            )).length;
            
            const projectArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('project') || tag.toLowerCase() === 'project'
            )).length;
            
            const documentArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('document') || tag.toLowerCase() === 'document'
            )).length;
            
            // 计算平均字数
            const avgWords = totalArticles > 0 ? Math.round(totalWords / totalArticles) : 0;
            
            // 计算平均阅读时间（假设每分钟阅读300字）
            const avgReadTime = avgWords > 0 ? Math.round(avgWords / 300) : 0;
            
            // 统计文档类型
            const docTypeStats = {};
            allArticles.forEach(article => {
                if (article.tags && Array.isArray(article.tags)) {
                    article.tags.forEach(tag => {
                        const lowerTag = tag.toLowerCase();
                        // 主要文档类型
                        const docTypes = ['project', 'document', 'api', 'guide', 'tutorial', 'note', 'web', 'python', 'lua'];
                        const matchedType = docTypes.find(type => lowerTag.includes(type) || lowerTag === type);
                        
                        if (matchedType) {
                            docTypeStats[matchedType] = (docTypeStats[matchedType] || 0) + 1;
                        }
                    });
                }
            });
            
            // 生成文档类型徽章HTML
            let docTypeBadgesHtml = '';
            if (Object.keys(docTypeStats).length > 0) {
                const docTypeNames = {
                    'project': '项目',
                    'document': '文档',
                    'api': 'API',
                    'guide': '指南',
                    'tutorial': '教程',
                    'note': '笔记',
                    'web': 'Web',
                    'python': 'Python',
                    'lua': 'Lua'
                };
                
                const sortedTypes = Object.entries(docTypeStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6); // 只显示前6个
                
                docTypeBadgesHtml = `
                    <div class="stats-doc-types">
                        <h4><i class="fas fa-tags"></i> 热门标签</h4>
                        <div class="doc-type-badges">
                            ${sortedTypes.map(([type, count]) => `
                                <span class="doc-type-badge">
                                    <span class="badge-count">${count}</span>
                                    ${docTypeNames[type] || type}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            statsSection.innerHTML = `
                <div class="stats-card">
                    <h4><i class="fas fa-chart-bar"></i> 文章统计</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">${totalArticles}</span>
                            <span class="stat-label">总文章数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatWordCount(totalWords)}</span>
                            <span class="stat-label">总字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${avgWords}</span>
                            <span class="stat-label">平均字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${avgReadTime}</span>
                            <span class="stat-label">平均阅读(分)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${webArticles}</span>
                            <span class="stat-label">Web开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${luaArticles}</span>
                            <span class="stat-label">Lua开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${pythonArticles}</span>
                            <span class="stat-label">Python</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${tutorialArticles}</span>
                            <span class="stat-label">教程</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${noteArticles}</span>
                            <span class="stat-label">笔记</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${projectArticles}</span>
                            <span class="stat-label">项目</span>
                        </div>
                    </div>
                    ${docTypeBadgesHtml}
                </div>
            `;
        }

        function initMarkdownViewer() {
            const backBtn = document.getElementById('backBtn');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const copyBtn = document.getElementById('copyBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const wordCountBtn = document.getElementById('wordCountBtn');
            const codeThemeSelect = document.getElementById('codeThemeSelect');
            const markdownViewer = document.getElementById('markdownViewer');
            const markdownSidebar = document.getElementById('markdownSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            backBtn.addEventListener('click', () => {
                markdownViewer.style.display = 'none';
            });
            
            toggleSidebarBtn.addEventListener('click', () => {
                markdownSidebar.classList.toggle('hidden');
            });
            
            wordCountBtn.addEventListener('click', () => {
                const content = document.getElementById('markdownContent');
                if (content) {
                    const wordCount = countWords(content.textContent);
                    const readTime = Math.ceil(wordCount / 300); // 假设每分钟300字
                    const paragraphs = content.querySelectorAll('p').length;
                    const codeBlocks = content.querySelectorAll('pre').length;
                    
                    document.getElementById('articleWordCount').textContent = wordCount;
                    document.getElementById('articleReadTime').textContent = readTime;
                    document.getElementById('articleParagraphs').textContent = paragraphs;
                    document.getElementById('articleCodeBlocks').textContent = codeBlocks;
                    
                    markdownSidebar.classList.remove('hidden');
                    showNotification(`当前文章: ${wordCount}字, 预计阅读${readTime}分钟`, 'info');
                }
            });
            
            // 点击遮罩层关闭侧边栏
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    markdownSidebar.classList.add('hidden');
                });
            }
            
            // 移动端：点击文章内容区域也关闭侧边栏
            if (window.innerWidth <= 768) {
                const markdownContent = document.getElementById('markdownContent');
                if (markdownContent) {
                    markdownContent.addEventListener('click', (e) => {
                        if (!markdownSidebar.classList.contains('hidden')) {
                            markdownSidebar.classList.add('hidden');
                        }
                    });
                }
            }
            
            copyBtn.addEventListener('click', () => {
                const content = document.getElementById('markdownContent');
                if (content) {
                    const text = content.innerText || content.textContent;
                    copyTextToClipboard(text, copyBtn);
                    
                    const copyConfirm = document.getElementById('copyConfirm');
                    if (copyConfirm && copyConfirm.checked) {
                        showNotification('文章内容已复制到剪贴板', 'success');
                    }
                }
            });
            
            codeThemeSelect.addEventListener('change', (e) => {
                const theme = e.target.value;
                changeCodeTheme(theme);
                localStorage.setItem('codeTheme', theme);
            });
            
            const savedTheme = localStorage.getItem('codeTheme') || 'github-dark';
            codeThemeSelect.value = savedTheme;
            changeCodeTheme(savedTheme);
            
            themeToggleBtn.addEventListener('click', () => {
                markdownSidebar.classList.remove('hidden');
            });
            
            // 移动端：监听窗口大小变化
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    markdownSidebar.classList.remove('hidden');
                }
            });
        }

        function countWords(text) {
            if (!text) return 0;
            // 中文字数统计
            const chineseWords = text.match(/[\u4e00-\u9fa5]/g) || [];
            // 英文单词统计（按空格分割）
            const englishWords = text.match(/\b\w+\b/g) || [];
            return chineseWords.length + englishWords.length;
        }

        function changeCodeTheme(theme) {
            const link = document.querySelector('link[href*="highlight.js"]');
            if (link) {
                const newTheme = theme === 'github' ? 'github.min.css' : `${theme}.min.css`;
                link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/${newTheme}`;
            }
        }

        async function openArticle(filename, title) {
            const markdownViewer = document.getElementById('markdownViewer');
            const markdownTitle = document.getElementById('markdownTitle');
            const markdownContent = document.getElementById('markdownContent');
            
            if (!filename) {
                console.error('文件名无效:', filename);
                markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>文件错误</h3>
                        <p>文章文件名为空或无效。</p>
                    </div>
                `;
                return;
            }
            
            markdownContent.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="loading-spinner"></div><p style="margin-top: 1rem;">加载文章中...</p></div>';
            markdownViewer.style.display = 'flex';
            markdownTitle.textContent = title || '文章阅读';
            
            // 移动端默认隐藏侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('markdownSidebar').classList.add('hidden');
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    throw new Error(`加载超时 (${currentLoadTimeout/1000}秒)`);
                }, currentLoadTimeout);
                
                const response = await fetch(`${ARTICLES_BASE_URL}${filename}`, {
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                const markdown = await response.text();
                
                console.log('加载Markdown成功，长度:', markdown.length);
                
                // 使用rendermd.js中的renderMarkdown函数
                let renderedHtml = '';
                if (window.renderMarkdown) {
                    renderedHtml = window.renderMarkdown(markdown);
                } else {
                    // 如果rendermd.js不可用，使用内置的简单渲染器
                    renderedHtml = renderSimpleMarkdown(markdown);
                }
                
                markdownContent.innerHTML = renderedHtml;
                
                // 为代码块添加事件监听器
                initializeCodeCopyButtons();
                
                generateTOC();
                
                // 更新字数统计
                const wordCount = countWords(markdownContent.textContent);
                const readTime = Math.ceil(wordCount / 300);
                const paragraphs = markdownContent.querySelectorAll('p').length;
                const codeBlocks = markdownContent.querySelectorAll('pre').length;
                
                document.getElementById('articleWordCount').textContent = wordCount;
                document.getElementById('articleReadTime').textContent = readTime;
                document.getElementById('articleParagraphs').textContent = paragraphs;
                document.getElementById('articleCodeBlocks').textContent = codeBlocks;
                
                if (window.hljs) {
                    const autoHighlight = document.getElementById('autoHighlight');
                    if (autoHighlight && autoHighlight.checked) {
                        hljs.highlightAll();
                    }
                }
                
                // 移动端：优化阅读体验
                if (window.innerWidth <= 768) {
                    optimizeMobileReading();
                }
                
                // 平滑滚动设置
                const smoothScroll = document.getElementById('smoothScroll');
                if (smoothScroll && smoothScroll.checked) {
                    applySmoothScroll();
                }
                
            } catch (error) {
                console.error('加载Markdown失败:', error);
                markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>加载失败</h3>
                        <p>无法加载文章内容: ${error.message}</p>
                        <p>文件路径: ${ARTICLES_BASE_URL}${filename}</p>
                        <p>当前超时设置: ${currentLoadTimeout/1000}秒</p>
                        <button onclick="downloadArticle('${filename}')" class="action-btn" style="margin-top: 1rem;">
                            <i class="fas fa-download"></i> 下载原始文件
                        </button>
                        <button onclick="increaseTimeout()" class="action-btn" style="margin-top: 0.5rem;">
                            <i class="fas fa-clock"></i> 增加超时时间
                        </button>
                    </div>
                `;
            }
        }

        function applySmoothScroll() {
            const links = document.querySelectorAll('.toc-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (href.startsWith('#')) {
                        e.preventDefault();
                        const target = document.querySelector(href);
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                });
            });
        }

        // 初始化代码复制按钮
        function initializeCodeCopyButtons() {
            // 为代码块添加事件监听器
            const codeBlocks = document.querySelectorAll('.code-block-wrapper');
            codeBlocks.forEach(wrapper => {
                const copyBtn = wrapper.querySelector('.copy-code-btn');
                if (copyBtn) {
                    // 移除现有的onclick事件
                    copyBtn.onclick = null;
                    
                    // 添加新的事件监听器
                    copyBtn.addEventListener('click', function() {
                        const codeElement = wrapper.querySelector('code');
                        if (codeElement) {
                            copyTextToClipboard(codeElement.textContent, this);
                        }
                    });
                }
            });
            
            // 为内联代码添加事件监听器
            const inlineCodeWrappers = document.querySelectorAll('.code-inline-wrapper');
            inlineCodeWrappers.forEach(wrapper => {
                const copyBtn = wrapper.querySelector('.inline-copy-btn');
                if (copyBtn) {
                    // 移除现有的onclick事件
                    copyBtn.onclick = null;
                    
                    // 添加新的事件监听器
                    copyBtn.addEventListener('click', function() {
                        const codeElement = wrapper.querySelector('code');
                        let codeText = '';
                        
                        if (codeElement) {
                            codeText = codeElement.textContent;
                        } else if (wrapper.dataset.code) {
                            codeText = wrapper.dataset.code;
                        }
                        
                        if (codeText) {
                            copyTextToClipboard(codeText, this, true);
                        } else {
                            showCopyError(this, true);
                        }
                    });
                }
            });
        }

        // HTML转义函数
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // 简单的markdown渲染函数 - 备用方案
        function renderSimpleMarkdown(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                return '<p>内容为空</p>';
            }
            
            let html = markdown;
            
            // 使用安全的ID生成器
            const codeId = generateSafeId('code');
            const inlineId = generateSafeId('inline');
            
            // 首先处理代码块
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                const languageName = getLanguageName(lang);
                const escapedCode = escapeHtml(code);
                
                return `
                    <div class="code-block-wrapper" data-code-id="${codeId}">
                        <div class="code-block-header">
                            <span class="code-language">${languageName}</span>
                            <button class="copy-code-btn" data-copy-target="${codeId}">
                                <i class="far fa-copy"></i><span>复制</span>
                            </button>
                        </div>
                        <pre><code class="${lang || ''}">${escapedCode}</code></pre>
                    </div>
                `;
            });
            
            // 转换标题
            html = html
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^##### (.*$)/gm, '<h5>$1</h5>')
                .replace(/^###### (.*$)/gm, '<h6>$1</h6>')
                // 转换加粗
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // 转换斜体
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // 转换行内代码
                .replace(/`([^`]+)`/g, function(match, code) {
                    if (code.length > 10) {
                        const escapedCode = escapeHtml(code);
                        return `
                            <span class="code-inline-wrapper" data-inline-id="${inlineId}" data-code="${escapedCode}">
                                <code>${code}</code>
                                <button class="inline-copy-btn" data-copy-inline="${inlineId}">
                                    <i class="far fa-copy"></i>
                                </button>
                            </span>
                        `;
                    }
                    return `<code>${escapeHtml(code)}</code>`;
                })
                // 转换链接
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, text, href) {
                    const escapedText = escapeHtml(text);
                    const escapedHref = escapeHtml(href);
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        return `<a href="${escapedHref}" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                    }
                    return `<a href="${escapedHref}">${escapedText}</a>`;
                })
                // 转换图片
                .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
                    const escapedAlt = escapeHtml(alt);
                    const escapedSrc = escapeHtml(src);
                    return `<img src="${escapedSrc}" alt="${escapedAlt}" style="max-width: 100%; height: auto;">`;
                })
                // 转换列表
                .replace(/^\s*\*\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\s*\+\s+(.*$)/gm, '<li>$1</li>')
                // 转换引用
                .replace(/^>\s*(.*$)/gm, '<blockquote>$1</blockquote>')
                // 转换段落
                .replace(/\n\n+/g, '</p><p>')
                .replace(/^([^<\n].*)/gm, '<p>$1</p>');
            
            // 处理列表
            html = html.replace(/<li>.*?<\/li>/g, function(match) {
                if (!match.includes('</ul>') && !match.includes('</ol>')) {
                    return '<ul>' + match + '</ul>';
                }
                return match;
            });
            
            return html;
        }

        // 安全的ID生成器
        function generateSafeId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        // 获取语言名称
        function getLanguageName(lang) {
            if (!lang) return '代码';
            
            const languageMap = {
                'js': 'JavaScript',
                'javascript': 'JavaScript',
                'py': 'Python',
                'python': 'Python',
                'lua': 'Lua',
                'html': 'HTML',
                'css': 'CSS',
                'json': 'JSON',
                'xml': 'XML',
                'bash': 'Bash',
                'sh': 'Shell',
                'md': 'Markdown',
                'cpp': 'C++',
                'c': 'C',
                'java': 'Java',
                'php': 'PHP',
                'ruby': 'Ruby',
                'go': 'Go',
                'rust': 'Rust',
                'ts': 'TypeScript',
                'typescript': 'TypeScript',
                'sql': 'SQL',
                'yaml': 'YAML',
                'yml': 'YAML',
                'txt': 'Text',
                'plaintext': 'Text'
            };
            
            return languageMap[lang.toLowerCase()] || lang.charAt(0).toUpperCase() + lang.slice(1);
        }

        // 复制代码块到剪贴板
        window.copyCodeBlock = function(codeBlockId, button) {
            const codeBlock = document.getElementById(codeBlockId);
            if (!codeBlock) {
                console.error('找不到代码块:', codeBlockId);
                
                // 尝试从按钮的父元素获取代码
                const parentBlock = button.closest('.code-block-wrapper');
                if (parentBlock) {
                    const codeElement = parentBlock.querySelector('code');
                    if (codeElement) {
                        copyTextToClipboard(codeElement.textContent, button);
                    }
                }
                return;
            }
            
            const codeElement = codeBlock.querySelector('code');
            if (!codeElement) {
                console.error('找不到代码元素');
                return;
            }
            
            copyTextToClipboard(codeElement.textContent, button);
        };

        // 复制内联代码到剪贴板
        window.copyInlineCode = function(inlineId, button) {
            const inlineWrapper = document.getElementById(inlineId);
            let codeText = '';
            
            if (inlineWrapper) {
                const codeElement = inlineWrapper.querySelector('code');
                if (codeElement) {
                    codeText = codeElement.textContent;
                } else if (inlineWrapper.dataset.code) {
                    codeText = inlineWrapper.dataset.code;
                }
            } else {
                // 尝试从按钮的父元素获取代码
                const parentWrapper = button.closest('.code-inline-wrapper');
                if (parentWrapper) {
                    const codeElement = parentWrapper.querySelector('code');
                    if (codeElement) {
                        codeText = codeElement.textContent;
                    } else if (parentWrapper.dataset.code) {
                        codeText = parentWrapper.dataset.code;
                    }
                }
            }
            
            if (codeText) {
                copyTextToClipboard(codeText, button, true);
            } else {
                console.error('找不到内联代码');
                showCopyError(button, true);
            }
        };

        // 通用复制文本到剪贴板函数
        function copyTextToClipboard(text, button, isInline = false) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(button, isInline);
            }).catch(err => {
                console.error('复制失败:', err);
                
                // 如果Clipboard API失败，尝试使用备用方法
                if (fallbackCopyToClipboard(text)) {
                    showCopySuccess(button, isInline);
                } else {
                    showCopyError(button, isInline);
                }
            });
        }

        // 备用复制方法
        function fallbackCopyToClipboard(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (err) {
                console.error('备用复制方法失败:', err);
                return false;
            }
        }

        // 显示复制成功状态
        function showCopySuccess(button, isInline) {
            const copyConfirm = document.getElementById('copyConfirm');
            if (copyConfirm && copyConfirm.checked) {
                if (isInline) {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.style.color = '#00ff00';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.color = '';
                    }, 2000);
                } else {
                    const originalHTML = button.innerHTML;
                    const originalClass = button.className;
                    
                    button.innerHTML = '<i class="fas fa-check"></i><span>已复制</span>';
                    button.className = originalClass + ' success';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.className = originalClass;
                    }, 2000);
                }
            }
        }

        // 显示复制错误状态
        function showCopyError(button, isInline) {
            if (isInline) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-times"></i>';
                button.style.color = '#ff0000';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.color = '';
                }, 2000);
            } else {
                const originalHTML = button.innerHTML;
                const originalClass = button.className;
                
                button.innerHTML = '<i class="fas fa-times"></i><span>失败</span>';
                button.className = originalClass + ' error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = originalClass;
                }, 2000);
            }
        }

        // 移动端阅读优化
        function optimizeMobileReading() {
            const content = document.getElementById('markdownContent');
            
            // 为代码块添加移动端优化
            const codeBlocks = content.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                block.style.overflowX = 'auto';
                block.style.WebkitOverflowScrolling = 'touch';
                block.style.maxWidth = '100%';
            });
            
            // 为表格添加滚动
            const tables = content.querySelectorAll('table');
            tables.forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.style.overflowX = 'auto';
                wrapper.style.WebkitOverflowScrolling = 'touch';
                wrapper.style.margin = '1rem 0';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
            
            // 调整图片大小
            const images = content.querySelectorAll('img');
            images.forEach(img => {
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
            });
        }

        function generateTOC() {
            const content = document.getElementById('markdownContent');
            const tocList = document.getElementById('tocList');
            const headings = content.querySelectorAll('h1, h2, h3, h4');
            
            tocList.innerHTML = '';
            
            if (headings.length === 0) {
                tocList.innerHTML = '<li class="toc-item"><span class="toc-link">暂无目录</span></li>';
                return;
            }
            
            headings.forEach((heading, index) => {
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }
                
                const level = parseInt(heading.tagName.substring(1));
                const listItem = document.createElement('li');
                listItem.className = `toc-item toc-level-${level}`;
                
                const link = document.createElement('a');
                link.href = `#${heading.id}`;
                link.className = 'toc-link';
                link.textContent = heading.textContent;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const smoothScroll = document.getElementById('smoothScroll');
                    if (smoothScroll && smoothScroll.checked) {
                        heading.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                    } else {
                        heading.scrollIntoView({ behavior: 'auto' });
                    }
                    
                    // 移动端：点击目录项后关闭侧边栏
                    if (window.innerWidth <= 768) {
                        document.getElementById('markdownSidebar').classList.add('hidden');
                    }
                });
                
                listItem.appendChild(link);
                tocList.appendChild(listItem);
            });
        }

        function downloadArticle(filename) {
            if (!filename) {
                alert('文件名无效，无法下载');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `${ARTICLES_BASE_URL}${filename}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function initThemeSwitcher() {
            const themeSwitcher = document.getElementById('themeSwitcher');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeSwitcher.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                updateSystemInfo();
                
                themeSwitcher.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    themeSwitcher.style.transform = '';
                }, 200);
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-moon';
                } else {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        }

        function initBackgroundToggle() {
            const bgToggle = document.getElementById('bgToggle');
            const bgContainer = document.getElementById('bgContainer');
            
            const bgVisible = localStorage.getItem('bgVisible') !== 'false';
            updateBackgroundVisibility(bgVisible);
            
            bgToggle.addEventListener('click', () => {
                const isVisible = bgContainer.style.opacity !== '0';
                updateBackgroundVisibility(!isVisible);
                localStorage.setItem('bgVisible', !isVisible);
                
                const icon = bgToggle.querySelector('i');
                if (!isVisible) {
                    icon.className = 'fas fa-eye';
                    bgToggle.title = '隐藏背景';
                } else {
                    icon.className = 'fas fa-eye-slash';
                    bgToggle.title = '显示背景';
                }
            });
            
            function updateBackgroundVisibility(visible) {
                if (visible) {
                    bgContainer.style.opacity = '1';
                    bgToggle.title = '隐藏背景';
                    bgToggle.querySelector('i').className = 'fas fa-eye';
                } else {
                    bgContainer.style.opacity = '0';
                    bgToggle.title = '显示背景';
                    bgToggle.querySelector('i').className = 'fas fa-eye-slash';
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 't') {
                document.getElementById('themeSwitcher').click();
            }
            if (e.altKey && e.key === 'b') {
                document.getElementById('bgToggle').click();
            }
            if (e.altKey && e.key === 'h') {
                window.location.href = 'index.html';
            }
            if (e.key === 'Escape') {
                const markdownViewer = document.getElementById('markdownViewer');
                if (markdownViewer.style.display === 'flex') {
                    document.getElementById('backBtn').click();
                } else if (isToolbarOpen) {
                    closeToolbarHandler();
                }
            }
            if (e.altKey && e.key === 'r') {
                loadArticles();
            }
            if (e.altKey && e.key === 'p') {
                toggleToolbar();
            }
            if (e.altKey && e.key === 'c') {
                const copyConfirm = document.getElementById('copyConfirm');
                if (copyConfirm) {
                    copyConfirm.checked = !copyConfirm.checked;
                    saveToolSettings();
                }
            }
        });
    </script>
</body>
</html>