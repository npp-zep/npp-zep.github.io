<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>文章导航 —— npp-zep</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/passage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/206399566?v=4">
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="bg-container" id="bgContainer">
        <div class="bg-overlay"></div>
        <img src="assets/pic/bg.png" alt="背景" class="bg-image" id="bgImage">
        <button class="bg-toggle" id="bgToggle" title="切换背景显示">
            <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="container">
        <header>
            <h1>文章导航
                <small>知识分享 · 学习笔记</small>
            </h1>
            <p class="tagline">记录思考，分享见解</p>
        </header>

        <main class="main-content">
            <section class="description">
                <div class="profile-header">
                    <img src="https://avatars.githubusercontent.com/u/206399566?v=4" alt="头像" class="avatar">
                    <h2>我的文章</h2>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-info-circle"></i> 说明</h3>
                    <p>这里是我在学习过程中整理的笔记和心得分享，内容涵盖编程技术、学习方法和项目经验等。所有文章都以Markdown格式编写，支持代码高亮和目录导航。</p>
                    
                    <h3><i class="fas fa-filter"></i> 筛选文章</h3>
                    <div class="filter-section">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">全部文章</button>
                            <button class="filter-btn" data-filter="web">Web开发</button>
                            <button class="filter-btn" data-filter="lua">Lua开发</button>
                            <button class="filter-btn" data-filter="python">Python</button>
                            <button class="filter-btn" data-filter="tutorial">教程</button>
                            <button class="filter-btn" data-filter="note">笔记</button>
                            <button class="filter-btn" data-filter="project">项目</button>
                            <button class="filter-btn" data-filter="document">文档</button>
                            <button class="filter-btn" data-filter="api">API文档</button>
                            <button class="filter-btn" data-filter="guide">指南</button>
                        </div>
                    </div>
                </div>

                <div class="articles-section">
                    <h3><i class="fas fa-book-open"></i> 文章列表</h3>
                    <div class="articles-list" id="articlesList">
                        <div class="loading-articles">
                            <div class="loading-spinner"></div>
                            <p>正在加载文章列表...</p>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="cta-section">
                <a href="index.html" class="btn">
                    <i class="fas fa-home"></i> 返回首页
                </a>
                
                <a href="https://github.com/npp-zep" target="_blank" class="btn">
                    <i class="fab fa-github"></i> GitHub 主页
                </a>
                
                <div class="quick-links">
                    <h4>快速链接</h4>
                    <a href="#articles" class="quick-link">查看文章</a>
                    <a href="#about" class="quick-link">关于本站</a>
                    <a href="https://github.com/npp-zep/npp-zep.github.io" target="_blank" class="quick-link">源代码</a>
                </div>
                
                <div class="stats-section" id="statsSection">
                </div>
            </aside>
        </main>

        <footer>
            <p>遵循 <a href="https://opensource.org/licenses/MIT" target="_blank" class="license-link">MIT 协议</a></p>
            <p class="footer-note">文章内容采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议</p>
        </footer>
    </div>

    <div class="markdown-viewer" id="markdownViewer">
        <div class="markdown-header">
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i> <span class="back-text">返回</span>
            </button>
            <h2 class="markdown-title" id="markdownTitle"></h2>
            <div class="markdown-actions">
                <button class="action-btn" id="toggleSidebarBtn">
                    <i class="fas fa-bars"></i> <span>目录</span>
                </button>
                <button class="action-btn" id="themeToggleBtn">
                    <i class="fas fa-palette"></i> <span>主题</span>
                </button>
                <button class="action-btn" id="copyBtn">
                    <i class="far fa-copy"></i> <span>复制</span>
                </button>
            </div>
        </div>
        
        <div class="markdown-container">
            <div class="markdown-sidebar" id="markdownSidebar">
                <h3 class="toc-title"><i class="fas fa-list"></i> 目录</h3>
                <ul class="toc-list" id="tocList">
                </ul>
                
                <div class="theme-options">
                    <h4><i class="fas fa-palette"></i> 代码主题</h4>
                    <select class="theme-select" id="codeThemeSelect">
                        <option value="github-dark">GitHub Dark</option>
                        <option value="github">GitHub Light</option>
                        <option value="vs2015">VS 2015</option>
                        <option value="atom-one-dark">Atom One Dark</option>
                        <option value="monokai">Monokai</option>
                        <option value="solarized-dark">Solarized Dark</option>
                    </select>
                </div>
                
                <!-- 简化版文章信息面板 -->
                <div class="article-info-panel" id="articleInfoPanel">
                    <h4><i class="fas fa-info-circle"></i> 文章信息</h4>
                    <div class="article-info-content">
                        <div class="info-item">
                            <span class="info-label">文章字数：</span>
                            <span class="info-value" id="articleWordCount">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">加载时间：</span>
                            <span class="info-value" id="articleLoadTime">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">阅读时长：</span>
                            <span class="info-value" id="articleReadTime">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">文件大小：</span>
                            <span class="info-value" id="articleFileSize">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 侧边栏遮罩层 -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <div class="markdown-content" id="markdownContent">
            </div>
        </div>
    </div>

    <button class="theme-switcher" id="themeSwitcher">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- 引入highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/markdown.min.js"></script>
    
    <!-- 引入marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- 引入修复后的rendermd.js -->
    <script src="script/rendermd.js"></script>
    
    <!-- 主脚本 -->
    <script>
        const ARTICLES_CONFIG_URL = 'assets/passage/articles.json';
        const ARTICLES_BASE_URL = 'assets/passage/';
        let allArticles = [];
        let currentArticleStats = null;

        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
            }, 800);
            
            loadArticles();
            initThemeSwitcher();
            initBackgroundToggle();
            initMarkdownViewer();
        });

        // 智能超时计算函数
        function calculateTimeout(fileSize) {
            // 基础超时时间
            let baseTimeout = 15000; // 15秒
            
            // 根据文件大小动态调整超时时间
            if (fileSize > 1024 * 1024) { // 大于1MB
                return 60000; // 60秒
            } else if (fileSize > 500 * 1024) { // 大于500KB
                return 45000; // 45秒
            } else if (fileSize > 100 * 1024) { // 大于100KB
                return 30000; // 30秒
            } else {
                return baseTimeout;
            }
        }

        async function loadArticles() {
            const articlesList = document.getElementById('articlesList');
            
            try {
                articlesList.innerHTML = `
                    <div class="loading-articles">
                        <div class="loading-spinner"></div>
                        <p>正在加载文章列表...</p>
                    </div>
                `;
                
                console.log('正在加载文章配置文件:', ARTICLES_CONFIG_URL);
                
                // 自动调整超时时间
                const timeout = calculateTimeout(0); // 配置文件通常较小
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(ARTICLES_CONFIG_URL, {
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status} - ${response.statusText}`);
                    }
                    
                    const jsonText = await response.text();
                    console.log('原始JSON数据:', jsonText.substring(0, 500) + '...');
                    
                    const cleanJsonText = jsonText.trim().replace(/^\uFEFF/, '');
                    const articlesData = JSON.parse(cleanJsonText);
                    
                    allArticles = articlesData.articles || [];
                    
                    if (!Array.isArray(allArticles) || allArticles.length === 0) {
                        throw new Error('文章数据格式错误或为空');
                    }
                    
                    // 清理和验证文章数据
                    allArticles = cleanArticlesData(allArticles);
                    
                    articlesList.innerHTML = '';
                    
                    allArticles.forEach((article, index) => {
                        console.log(`处理文章 ${index + 1}:`, {
                            title: article.title,
                            description: article.description,
                            descriptionType: typeof article.description
                        });
                        
                        const articleElement = createArticleCard(article);
                        articlesList.appendChild(articleElement);
                    });
                    
                    updateStats();
                    initFilter();
                    
                    console.log('成功加载', allArticles.length, '篇文章');
                    
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error(`加载超时（${timeout/1000}秒）。请检查网络连接或稍后重试。`);
                    }
                    throw fetchError;
                }
                
            } catch (error) {
                console.error('加载文章失败:', error);
                showError('无法加载文章列表', error.message);
            }
        }

        // 清理和验证文章数据
        function cleanArticlesData(articles) {
            return articles.map(article => {
                const cleaned = {};
                
                // 确保所有字段都是字符串
                cleaned.title = String(article.title || '无标题');
                cleaned.date = String(article.date || '未知日期');
                cleaned.readTime = String(article.readTime || '未知');
                cleaned.description = String(article.description || '暂无描述');
                cleaned.file = String(article.file || '');
                
                // 添加字数统计 - 从配置文件读取或自动计算
                if (article.wordCount !== undefined) {
                    cleaned.wordCount = parseInt(article.wordCount) || 0;
                } else if (article.words !== undefined) {
                    cleaned.wordCount = parseInt(article.words) || 0;
                } else {
                    // 如果没有配置字数，使用描述的长度作为估算
                    cleaned.wordCount = Math.max(
                        cleaned.description.length * 3,
                        800
                    );
                }
                
                // 处理tags - 确保是数组
                if (Array.isArray(article.tags)) {
                    cleaned.tags = article.tags.map(tag => String(tag));
                } else if (typeof article.tags === 'string') {
                    // 处理逗号分隔的标签字符串
                    cleaned.tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                } else {
                    cleaned.tags = [];
                }
                
                // 额外的安全检查和清理
                if (cleaned.description === '[object Object]') {
                    console.warn('检测到 [object Object] 描述，替换为默认描述');
                    cleaned.description = '暂无描述';
                }
                
                // 清理描述中的特殊字符
                if (cleaned.description && cleaned.description.includes('[project]')) {
                    console.warn('检测到特殊描述模式，进行清理:', cleaned.description);
                    cleaned.description = cleaned.description.replace(/\[project\]\s*:\s*project/g, '项目说明');
                }
                
                return cleaned;
            });
        }

        function showError(title, message) {
            const articlesList = document.getElementById('articlesList');
            
            articlesList.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <p style="font-size: 0.85rem; margin-top: 1rem;">请检查文件路径是否正确，并确保 <code>articles.json</code> 文件存在。</p>
                    <button onclick="loadArticles()" class="article-btn" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> 重试加载
                    </button>
                </div>
            `;
            
            document.getElementById('statsSection').innerHTML = '';
        }

        function createArticleCard(article) {
            const articleCard = document.createElement('div');
            articleCard.className = 'article-card';
            
            // 确保tags是字符串数组
            const tagsArray = Array.isArray(article.tags) ? article.tags : 
                            (typeof article.tags === 'string' ? 
                             article.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []);
            
            articleCard.dataset.tags = tagsArray.join(' ');
            
            const tagsHtml = tagsArray.map(tag => 
                `<span class="article-tag tag-${tag.toLowerCase()}">${tag}</span>`
            ).join('');
            
            // 使用事件监听器而不是onclick属性，避免转义问题
            const safeFile = article.file || '';
            const safeTitle = article.title || '无标题';
            const safeDescription = article.description || '暂无描述';
            
            // 双重检查，防止 [object Object]
            const finalDescription = typeof safeDescription === 'object' ? '暂无描述' : safeDescription;
            
            // 格式化字数显示
            const wordCount = article.wordCount || 0;
            const wordCountFormatted = formatWordCount(wordCount);
            
            articleCard.innerHTML = `
                <div class="article-header">
                    <h4 class="article-title">${article.title || '无标题'}</h4>
                    <div class="article-meta">
                        <span class="article-date"><i class="far fa-calendar"></i> ${article.date || '未知日期'}</span>
                        <span class="article-read-time"><i class="far fa-clock"></i> ${article.readTime || '未知'}</span>
                        <span class="article-word-count"><i class="fas fa-file-word"></i> ${wordCountFormatted}</span>
                    </div>
                </div>
                <p class="article-description">${finalDescription}</p>
                <div class="article-footer">
                    <div class="article-tags">
                        ${tagsHtml}
                    </div>
                    <div class="article-actions">
                        <button class="article-btn read-btn">
                            <i class="fas fa-book-open"></i> 阅读
                        </button>
                        <button class="article-btn download-btn">
                            <i class="fas fa-download"></i> 下载
                        </button>
                    </div>
                </div>
            `;
            
            // 使用事件委托添加点击事件
            const readBtn = articleCard.querySelector('.read-btn');
            const downloadBtn = articleCard.querySelector('.download-btn');
            
            readBtn.addEventListener('click', () => {
                openArticle(safeFile, safeTitle, article);
            });
            
            downloadBtn.addEventListener('click', () => {
                downloadArticle(safeFile);
            });
            
            return articleCard;
        }

        function initFilter() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            const articlesList = document.getElementById('articlesList');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    const articleCards = document.querySelectorAll('.article-card');
                    
                    articleCards.forEach(card => {
                        if (filter === 'all' || card.dataset.tags.includes(filter)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    articlesList.style.opacity = '0.5';
                    setTimeout(() => {
                        articlesList.style.opacity = '1';
                    }, 300);
                });
            });
        }

        function updateStats() {
            const statsSection = document.getElementById('statsSection');
            
            if (!allArticles || allArticles.length === 0) {
                statsSection.innerHTML = '';
                return;
            }
            
            const totalArticles = allArticles.length;
            
            // 计算总字数（从配置中读取）
            let totalWords = 0;
            let validWordCountArticles = 0;
            
            allArticles.forEach(article => {
                if (article.wordCount && article.wordCount > 0) {
                    totalWords += article.wordCount;
                    validWordCountArticles++;
                }
            });
            
            // 如果没有配置字数，使用估算
            if (totalWords === 0) {
                totalWords = allArticles.length * 800; // 默认每篇800字
            }
            
            // 计算各类别文章数量
            const webArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('web') || tag.toLowerCase() === 'web'
            )).length;
            
            const luaArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('lua') || tag.toLowerCase() === 'lua'
            )).length;
            
            const pythonArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('python') || tag.toLowerCase() === 'python'
            )).length;
            
            const tutorialArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('tutorial') || tag.toLowerCase() === 'tutorial'
            )).length;
            
            const noteArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('note') || tag.toLowerCase() === 'note'
            )).length;
            
            const projectArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('project') || tag.toLowerCase() === 'project'
            )).length;
            
            const documentArticles = allArticles.filter(a => a.tags && a.tags.some(tag => 
                tag.toLowerCase().includes('document') || tag.toLowerCase() === 'document'
            )).length;
            
            // 创建更合理的统计
            const totalDays = Math.max(totalArticles * 3, 30); // 假设每篇文章平均间隔3天
            const months = Math.floor(totalDays / 30);
            
            // 格式化字数显示
            const wordsDisplay = formatWordCount(totalWords);
            
            // 统计文档类型
            const docTypeStats = {};
            allArticles.forEach(article => {
                if (article.tags && Array.isArray(article.tags)) {
                    article.tags.forEach(tag => {
                        const lowerTag = tag.toLowerCase();
                        // 主要文档类型
                        const docTypes = ['project', 'document', 'api', 'guide', 'tutorial', 'note', 'web', 'python', 'lua'];
                        const matchedType = docTypes.find(type => lowerTag.includes(type) || lowerTag === type);
                        
                        if (matchedType) {
                            docTypeStats[matchedType] = (docTypeStats[matchedType] || 0) + 1;
                        }
                    });
                }
            });
            
            // 生成文档类型徽章HTML
            let docTypeBadgesHtml = '';
            if (Object.keys(docTypeStats).length > 0) {
                const docTypeNames = {
                    'project': '项目',
                    'document': '文档',
                    'api': 'API',
                    'guide': '指南',
                    'tutorial': '教程',
                    'note': '笔记',
                    'web': 'Web',
                    'python': 'Python',
                    'lua': 'Lua'
                };
                
                const sortedTypes = Object.entries(docTypeStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6); // 只显示前6个
                
                docTypeBadgesHtml = `
                    <div class="stats-doc-types">
                        <h4><i class="fas fa-tags"></i> 热门标签</h4>
                        <div class="doc-type-badges">
                            ${sortedTypes.map(([type, count]) => `
                                <span class="doc-type-badge">
                                    <span class="badge-count">${count}</span>
                                    ${docTypeNames[type] || type}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 字数统计详情
            const avgWordsPerArticle = Math.round(totalWords / Math.max(totalArticles, 1));
            const maxWordsArticle = allArticles.reduce((max, article) => 
                Math.max(max, article.wordCount || 0), 0);
            const minWordsArticle = allArticles.reduce((min, article) => 
                Math.min(min, article.wordCount > 0 ? article.wordCount : Infinity), Infinity);
            
            statsSection.innerHTML = `
                <div class="stats-card">
                    <h4><i class="fas fa-chart-bar"></i> 文章统计</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">${totalArticles}</span>
                            <span class="stat-label">总文章数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${wordsDisplay}</span>
                            <span class="stat-label">总字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(avgWordsPerArticle)}</span>
                            <span class="stat-label">平均字数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${webArticles}</span>
                            <span class="stat-label">Web开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${luaArticles}</span>
                            <span class="stat-label">Lua开发</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${pythonArticles}</span>
                            <span class="stat-label">Python</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${tutorialArticles}</span>
                            <span class="stat-label">教程</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${noteArticles}</span>
                            <span class="stat-label">笔记</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${projectArticles}</span>
                            <span class="stat-label">项目</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${documentArticles}</span>
                            <span class="stat-label">文档</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${months}</span>
                            <span class="stat-label">持续${months}个月</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(maxWordsArticle)}</span>
                            <span class="stat-label">最长文章</span>
                        </div>
                    </div>
                    <div class="word-count-details">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.8rem;">
                            <i class="fas fa-info-circle"></i> 
                            统计了 ${validWordCountArticles}/${totalArticles} 篇文章的实际字数
                        </p>
                    </div>
                    ${docTypeBadgesHtml}
                </div>
            `;
        }

        function formatWordCount(wordCount) {
            if (wordCount >= 10000) {
                return `${(wordCount / 10000).toFixed(1)}万`;
            } else if (wordCount >= 1000) {
                return `${(wordCount / 1000).toFixed(1)}千`;
            } else {
                return formatNumber(wordCount);
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function initMarkdownViewer() {
            const backBtn = document.getElementById('backBtn');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const copyBtn = document.getElementById('copyBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const codeThemeSelect = document.getElementById('codeThemeSelect');
            const markdownViewer = document.getElementById('markdownViewer');
            const markdownSidebar = document.getElementById('markdownSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            backBtn.addEventListener('click', () => {
                markdownViewer.style.display = 'none';
                resetArticleInfo();
            });
            
            toggleSidebarBtn.addEventListener('click', () => {
                markdownSidebar.classList.toggle('hidden');
            });
            
            // 点击遮罩层关闭侧边栏
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    markdownSidebar.classList.add('hidden');
                });
            }
            
            // 移动端：点击文章内容区域也关闭侧边栏
            if (window.innerWidth <= 768) {
                const markdownContent = document.getElementById('markdownContent');
                if (markdownContent) {
                    markdownContent.addEventListener('click', (e) => {
                        if (!markdownSidebar.classList.contains('hidden')) {
                            markdownSidebar.classList.add('hidden');
                        }
                    });
                }
            }
            
            copyBtn.addEventListener('click', () => {
                const content = document.getElementById('markdownContent').innerText;
                if (!content || content.trim() === '') {
                    showCopyStatus('内容为空，无法复制', false);
                    return;
                }
                
                navigator.clipboard.writeText(content).then(() => {
                    showCopyStatus('已复制到剪贴板', true);
                }).catch(err => {
                    console.error('复制失败:', err);
                    showCopyStatus('复制失败，请重试', false);
                });
            });
            
            codeThemeSelect.addEventListener('change', (e) => {
                const theme = e.target.value;
                changeCodeTheme(theme);
                localStorage.setItem('codeTheme', theme);
            });
            
            const savedTheme = localStorage.getItem('codeTheme') || 'github-dark';
            codeThemeSelect.value = savedTheme;
            changeCodeTheme(savedTheme);
            
            themeToggleBtn.addEventListener('click', () => {
                markdownSidebar.classList.remove('hidden');
            });
            
            // 移动端：监听窗口大小变化
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    markdownSidebar.classList.remove('hidden');
                }
            });
        }

        function resetArticleInfo() {
            document.getElementById('articleWordCount').textContent = '--';
            document.getElementById('articleLoadTime').textContent = '--';
            document.getElementById('articleReadTime').textContent = '--';
            document.getElementById('articleFileSize').textContent = '--';
            
            currentArticleStats = null;
        }

        function updateArticleInfo(stats) {
            const articleWordCount = document.getElementById('articleWordCount');
            const articleLoadTime = document.getElementById('articleLoadTime');
            const articleReadTime = document.getElementById('articleReadTime');
            const articleFileSize = document.getElementById('articleFileSize');
            
            articleWordCount.textContent = formatWordCount(stats.wordCount);
            articleLoadTime.textContent = `${stats.loadTime}ms`;
            articleReadTime.textContent = stats.readTime;
            articleFileSize.textContent = stats.fileSize;
        }

        function showCopyStatus(message, success) {
            const copyBtn = document.getElementById('copyBtn');
            const originalHTML = copyBtn.innerHTML;
            
            if (success) {
                copyBtn.innerHTML = '<i class="fas fa-check"></i> <span>已复制</span>';
                copyBtn.className = 'action-btn success';
            } else {
                copyBtn.innerHTML = '<i class="fas fa-times"></i> <span>失败</span>';
                copyBtn.className = 'action-btn error';
            }
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.className = 'action-btn';
            }, 2000);
        }

        function changeCodeTheme(theme) {
            const link = document.querySelector('link[href*="highlight.js"]');
            if (link) {
                const newTheme = theme === 'github' ? 'github.min.css' : `${theme}.min.css`;
                link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/${newTheme}`;
            }
        }

        async function openArticle(filename, title, articleInfo = null) {
            const markdownViewer = document.getElementById('markdownViewer');
            const markdownTitle = document.getElementById('markdownTitle');
            const markdownContent = document.getElementById('markdownContent');
            
            if (!filename) {
                console.error('文件名无效:', filename);
                markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>文件错误</h3>
                        <p>文章文件名为空或无效。</p>
                    </div>
                `;
                return;
            }
            
            const loadStartTime = Date.now();
            
            // 更新文章信息面板
            currentArticleStats = {
                fileName: filename,
                originalArticle: articleInfo,
                wordCount: articleInfo?.wordCount || 0,
                loadStartTime: loadStartTime,
                loadSuccess: false
            };
            
            markdownContent.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="loading-spinner"></div><p style="margin-top: 1rem;">加载文章中...</p></div>';
            markdownViewer.style.display = 'flex';
            markdownTitle.textContent = title || '文章阅读';
            
            // 移动端默认隐藏侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('markdownSidebar').classList.add('hidden');
            }
            
            try {
                // 先获取文件大小以动态调整超时时间
                const headResponse = await fetch(`${ARTICLES_BASE_URL}${filename}`, { method: 'HEAD' });
                const fileSize = headResponse.headers.get('content-length') || 0;
                const timeout = calculateTimeout(fileSize);
                
                // 设置加载超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                let response;
                try {
                    response = await fetch(`${ARTICLES_BASE_URL}${filename}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const markdown = await response.text();
                    const loadTime = Date.now() - loadStartTime;
                    
                    console.log('加载Markdown成功，长度:', markdown.length);
                    
                    // 更新文章统计信息
                    const actualFileSize = markdown.length;
                    const wordCount = countWords(markdown);
                    const readTime = calculateReadTime(wordCount);
                    
                    currentArticleStats = {
                        ...currentArticleStats,
                        wordCount: wordCount,
                        loadTime: loadTime,
                        readTime: readTime,
                        fileSize: formatFileSize(actualFileSize),
                        loadSuccess: true
                    };
                    
                    updateArticleInfo(currentArticleStats);
                    
                    // 使用rendermd.js中的renderMarkdown函数
                    let renderedHtml = '';
                    if (window.renderMarkdown) {
                        renderedHtml = window.renderMarkdown(markdown);
                    } else {
                        // 如果rendermd.js不可用，使用内置的简单渲染器
                        renderedHtml = renderSimpleMarkdown(markdown);
                    }
                    
                    markdownContent.innerHTML = renderedHtml;
                    
                    // 为代码块添加事件监听器
                    initializeCodeCopyButtons();
                    
                    generateTOC();
                    if (window.hljs) {
                        hljs.highlightAll();
                    }
                    
                    // 移动端：优化阅读体验
                    if (window.innerWidth <= 768) {
                        optimizeMobileReading();
                    }
                    
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error(`加载超时（${timeout/1000}秒）。请稍后重试。`);
                    }
                    throw fetchError;
                }
                
            } catch (error) {
                console.error('加载Markdown失败:', error);
                
                currentArticleStats = {
                    ...currentArticleStats,
                    loadSuccess: false,
                    loadTime: Date.now() - loadStartTime
                };
                
                updateArticleInfo(currentArticleStats);
                
                markdownContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>加载失败</h3>
                        <p>无法加载文章内容: ${error.message}</p>
                        <p>文件路径: ${ARTICLES_BASE_URL}${filename}</p>
                        <p>已用时: ${currentArticleStats.loadTime}ms</p>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="openArticle('${filename}', '${title}', ${articleInfo ? JSON.stringify(articleInfo).replace(/"/g, '&quot;') : 'null'})" class="action-btn">
                                <i class="fas fa-redo"></i> 重试
                            </button>
                            <button onclick="downloadArticle('${filename}')" class="action-btn">
                                <i class="fas fa-download"></i> 下载原始文件
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function countWords(text) {
            if (!text) return 0;
            // 移除代码块和HTML标签
            const cleanText = text.replace(/```[\s\S]*?```/g, '')
                                 .replace(/`[^`]+`/g, '')
                                 .replace(/<[^>]*>/g, '')
                                 .replace(/\s+/g, ' ')
                                 .trim();
            
            // 中文字符按字计数，英文单词按空格分隔计数
            const chineseChars = cleanText.match(/[\u4e00-\u9fa5]/g) || [];
            const englishWords = cleanText.replace(/[\u4e00-\u9fa5]/g, ' ')
                                         .split(/\s+/)
                                         .filter(word => word.length > 0);
            
            return chineseChars.length + englishWords.length;
        }

        function calculateReadTime(wordCount) {
            const wordsPerMinute = 300; // 平均阅读速度
            const minutes = Math.ceil(wordCount / wordsPerMinute);
            
            if (minutes < 1) return '<1分钟';
            if (minutes < 60) return `${minutes}分钟`;
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (remainingMinutes === 0) return `${hours}小时`;
            return `${hours}小时${remainingMinutes}分钟`;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // HTML转义函数
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // 简单的markdown渲染函数 - 备用方案
        function renderSimpleMarkdown(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                return '<p>内容为空</p>';
            }
            
            let html = markdown;
            
            // 使用安全的ID生成器
            const codeId = generateSafeId('code');
            const inlineId = generateSafeId('inline');
            
            // 首先处理代码块
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                const languageName = getLanguageName(lang);
                const escapedCode = escapeHtml(code);
                
                return `
                    <div class="code-block-wrapper" data-code-id="${codeId}">
                        <div class="code-block-header">
                            <span class="code-language">${languageName}</span>
                            <button class="copy-code-btn" data-copy-target="${codeId}">
                                <i class="far fa-copy"></i><span>复制</span>
                            </button>
                        </div>
                        <pre><code class="${lang || ''}">${escapedCode}</code></pre>
                    </div>
                `;
            });
            
            // 转换标题
            html = html
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^##### (.*$)/gm, '<h5>$1</h5>')
                .replace(/^###### (.*$)/gm, '<h6>$1</h6>')
                // 转换加粗
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // 转换斜体
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // 转换行内代码
                .replace(/`([^`]+)`/g, function(match, code) {
                    if (code.length > 10) {
                        const escapedCode = escapeHtml(code);
                        return `
                            <span class="code-inline-wrapper" data-inline-id="${inlineId}" data-code="${escapedCode}">
                                <code>${code}</code>
                                <button class="inline-copy-btn" data-copy-inline="${inlineId}">
                                    <i class="far fa-copy"></i>
                                </button>
                            </span>
                        `;
                    }
                    return `<code>${escapeHtml(code)}</code>`;
                })
                // 转换链接
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, text, href) {
                    const escapedText = escapeHtml(text);
                    const escapedHref = escapeHtml(href);
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        return `<a href="${escapedHref}" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                    }
                    return `<a href="${escapedHref}">${escapedText}</a>`;
                })
                // 转换图片
                .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
                    const escapedAlt = escapeHtml(alt);
                    const escapedSrc = escapeHtml(src);
                    return `<img src="${escapedSrc}" alt="${escapedAlt}" style="max-width: 100%; height: auto;">`;
                })
                // 转换列表
                .replace(/^\s*\*\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\s*\+\s+(.*$)/gm, '<li>$1</li>')
                // 转换引用
                .replace(/^>\s*(.*$)/gm, '<blockquote>$1</blockquote>')
                // 转换段落
                .replace(/\n\n+/g, '</p><p>')
                .replace(/^([^<\n].*)/gm, '<p>$1</p>');
            
            // 处理列表
            html = html.replace(/<li>.*?<\/li>/g, function(match) {
                if (!match.includes('</ul>') && !match.includes('</ol>')) {
                    return '<ul>' + match + '</ul>';
                }
                return match;
            });
            
            return html;
        }

        // 安全的ID生成器
        function generateSafeId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        // 获取语言名称
        function getLanguageName(lang) {
            if (!lang) return '代码';
            
            const languageMap = {
                'js': 'JavaScript',
                'javascript': 'JavaScript',
                'py': 'Python',
                'python': 'Python',
                'lua': 'Lua',
                'html': 'HTML',
                'css': 'CSS',
                'json': 'JSON',
                'xml': 'XML',
                'bash': 'Bash',
                'sh': 'Shell',
                'md': 'Markdown',
                'cpp': 'C++',
                'c': 'C',
                'java': 'Java',
                'php': 'PHP',
                'ruby': 'Ruby',
                'go': 'Go',
                'rust': 'Rust',
                'ts': 'TypeScript',
                'typescript': 'TypeScript',
                'sql': 'SQL',
                'yaml': 'YAML',
                'yml': 'YAML',
                'txt': 'Text',
                'plaintext': 'Text'
            };
            
            return languageMap[lang.toLowerCase()] || lang.charAt(0).toUpperCase() + lang.slice(1);
        }

        // 初始化代码复制按钮
        function initializeCodeCopyButtons() {
            // 为代码块添加事件监听器
            const codeBlocks = document.querySelectorAll('.code-block-wrapper');
            codeBlocks.forEach(wrapper => {
                const copyBtn = wrapper.querySelector('.copy-code-btn');
                if (copyBtn) {
                    // 移除现有的onclick事件
                    copyBtn.onclick = null;
                    
                    // 添加新的事件监听器
                    copyBtn.addEventListener('click', function() {
                        const codeElement = wrapper.querySelector('code');
                        if (codeElement) {
                            copyTextToClipboard(codeElement.textContent, this);
                        }
                    });
                }
            });
            
            // 为内联代码添加事件监听器
            const inlineCodeWrappers = document.querySelectorAll('.code-inline-wrapper');
            inlineCodeWrappers.forEach(wrapper => {
                const copyBtn = wrapper.querySelector('.inline-copy-btn');
                if (copyBtn) {
                    // 移除现有的onclick事件
                    copyBtn.onclick = null;
                    
                    // 添加新的事件监听器
                    copyBtn.addEventListener('click', function() {
                        const codeElement = wrapper.querySelector('code');
                        let codeText = '';
                        
                        if (codeElement) {
                            codeText = codeElement.textContent;
                        } else if (wrapper.dataset.code) {
                            codeText = wrapper.dataset.code;
                        }
                        
                        if (codeText) {
                            copyTextToClipboard(codeText, this, true);
                        } else {
                            showCopyError(this, true);
                        }
                    });
                }
            });
        }

        // 通用复制文本到剪贴板函数
        function copyTextToClipboard(text, button, isInline = false) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(button, isInline);
            }).catch(err => {
                console.error('复制失败:', err);
                
                // 如果Clipboard API失败，尝试使用备用方法
                if (fallbackCopyToClipboard(text)) {
                    showCopySuccess(button, isInline);
                } else {
                    showCopyError(button, isInline);
                }
            });
        }

        // 备用复制方法
        function fallbackCopyToClipboard(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (err) {
                console.error('备用复制方法失败:', err);
                return false;
            }
        }

        // 显示复制成功状态
        function showCopySuccess(button, isInline) {
            if (isInline) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.style.color = '#00ff00';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.color = '';
                }, 2000);
            } else {
                const originalHTML = button.innerHTML;
                const originalClass = button.className;
                
                button.innerHTML = '<i class="fas fa-check"></i><span>已复制</span>';
                button.className = originalClass + ' success';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = originalClass;
                }, 2000);
            }
        }

        // 显示复制错误状态
        function showCopyError(button, isInline) {
            if (isInline) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-times"></i>';
                button.style.color = '#ff0000';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.color = '';
                }, 2000);
            } else {
                const originalHTML = button.innerHTML;
                const originalClass = button.className;
                
                button.innerHTML = '<i class="fas fa-times"></i><span>失败</span>';
                button.className = originalClass + ' error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = originalClass;
                }, 2000);
            }
        }

        // 移动端阅读优化
        function optimizeMobileReading() {
            const content = document.getElementById('markdownContent');
            
            // 为代码块添加移动端优化
            const codeBlocks = content.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                block.style.overflowX = 'auto';
                block.style.WebkitOverflowScrolling = 'touch';
                block.style.maxWidth = '100%';
            });
            
            // 为表格添加滚动
            const tables = content.querySelectorAll('table');
            tables.forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.style.overflowX = 'auto';
                wrapper.style.WebkitOverflowScrolling = 'touch';
                wrapper.style.margin = '1rem 0';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
            
            // 调整图片大小
            const images = content.querySelectorAll('img');
            images.forEach(img => {
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
            });
        }

        function generateTOC() {
            const content = document.getElementById('markdownContent');
            const tocList = document.getElementById('tocList');
            const headings = content.querySelectorAll('h1, h2, h3, h4');
            
            tocList.innerHTML = '';
            
            if (headings.length === 0) {
                tocList.innerHTML = '<li class="toc-item"><span class="toc-link">暂无目录</span></li>';
                return;
            }
            
            headings.forEach((heading, index) => {
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }
                
                const level = parseInt(heading.tagName.substring(1));
                const listItem = document.createElement('li');
                listItem.className = `toc-item toc-level-${level}`;
                
                const link = document.createElement('a');
                link.href = `#${heading.id}`;
                link.className = 'toc-link';
                link.textContent = heading.textContent;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    heading.scrollIntoView({ behavior: 'smooth' });
                    
                    // 移动端：点击目录项后关闭侧边栏
                    if (window.innerWidth <= 768) {
                        document.getElementById('markdownSidebar').classList.add('hidden');
                    }
                });
                
                listItem.appendChild(link);
                tocList.appendChild(listItem);
            });
        }

        function downloadArticle(filename) {
            if (!filename) {
                alert('文件名无效，无法下载');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `${ARTICLES_BASE_URL}${filename}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function initThemeSwitcher() {
            const themeSwitcher = document.getElementById('themeSwitcher');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeSwitcher.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                themeSwitcher.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    themeSwitcher.style.transform = '';
                }, 200);
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-moon';
                } else {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        }

        function initBackgroundToggle() {
            const bgToggle = document.getElementById('bgToggle');
            const bgContainer = document.getElementById('bgContainer');
            
            const bgVisible = localStorage.getItem('bgVisible') !== 'false';
            updateBackgroundVisibility(bgVisible);
            
            bgToggle.addEventListener('click', () => {
                const isVisible = bgContainer.style.opacity !== '0';
                updateBackgroundVisibility(!isVisible);
                localStorage.setItem('bgVisible', !isVisible);
                
                const icon = bgToggle.querySelector('i');
                if (!isVisible) {
                    icon.className = 'fas fa-eye';
                    bgToggle.title = '隐藏背景';
                } else {
                    icon.className = 'fas fa-eye-slash';
                    bgToggle.title = '显示背景';
                }
            });
            
            function updateBackgroundVisibility(visible) {
                if (visible) {
                    bgContainer.style.opacity = '1';
                    bgToggle.title = '隐藏背景';
                    bgToggle.querySelector('i').className = 'fas fa-eye';
                } else {
                    bgContainer.style.opacity = '0';
                    bgToggle.title = '显示背景';
                    bgToggle.querySelector('i').className = 'fas fa-eye-slash';
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 't') {
                document.getElementById('themeSwitcher').click();
            }
            if (e.altKey && e.key === 'b') {
                document.getElementById('bgToggle').click();
            }
            if (e.altKey && e.key === 'h') {
                window.location.href = 'index.html';
            }
            if (e.key === 'Escape') {
                const markdownViewer = document.getElementById('markdownViewer');
                if (markdownViewer.style.display === 'flex') {
                    document.getElementById('backBtn').click();
                }
            }
            if (e.altKey && e.key === 'r') {
                loadArticles();
            }
        });
    </script>
</body>
</html>